<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hq.ecmp.mscore.mapper.OrderInfoMapper">

    <resultMap type="com.hq.ecmp.mscore.domain.OrderInfo" id="OrderInfoResult">
        <result property="orderId"    column="order_id"    />
        <result property="journeyId"    column="journey_id"    />
        <result property="companyId"    column="company_id"    />
        <result property="nodeId"    column="node_id"    />
        <result property="powerId"    column="power_id"    />
        <result property="driverId"    column="driver_id"    />
        <result property="carId"    column="car_id"    />
        <result property="userId"    column="user_id"    />
        <result property="useCarMode"    column="use_car_mode"    />
        <result property="serviceType"    column="service_type"    />
        <result property="state"    column="state"    />
        <result property="tripartiteOrderId"    column="tripartite_order_id"    />
        <result property="tripartitePlatformCode"    column="tripartite_platform_code"    />
        <result property="driverName"    column="driver_name"    />
        <result property="driverMobile"    column="driver_mobile"    />
        <result property="carLicense"    column="car_license"    />
        <result property="flightNumber"    column="flight_number"    />
        <result property="demandCarLevel"    column="demand_car_level"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="orderNumber"    column="order_number"    />
        <result property="carModel"    column="car_model"    />
        <result property="carColor"    column="car_color"    />
        <result property="driverGrade"    column="driver_grade"    />
        <result property="flightPlanTakeOffTime"    column="flight_plan_take_off_time"    />

    </resultMap>

    <sql id="selectOrderInfoVo">
        select order_id,company_id, order_number,journey_id, node_id, power_id, driver_id, car_id, user_id, use_car_mode, service_type, state, tripartite_order_id, tripartite_platform_code, driver_name, driver_mobile, car_license, flight_number, demand_car_level, create_by, create_time, update_by, update_time,car_model,car_color,driver_grade ,flight_plan_take_off_time,it_is_supplement from order_info
    </sql>

    <sql id="queryDispatchAchieve">
    SELECT
	a.order_id AS orderId,
	a.state,
	d.apply_type AS applyType,
	b.type AS serverType,
	c.plan_begin_address AS useCarCity,
	e.nick_name AS applyUserName,
	e.nick_name AS useCarUserName,
<!-- 	a.actual_setout_address AS startSite,
	a.actual_setout_time AS useCarDate,
	a.actual_arrive_address AS endSite,
	a.actual_arrive_time AS endDate, -->
	a.use_car_mode AS useCarMode,
	a.driver_name AS driverName,
	a.driver_mobile AS driverTel,
	f.car_type as carType,
	f.car_license AS carLicense,
	h.regimen_id as regimenId,
	h.it_is_return as itIsReturn
FROM
	order_info a
LEFT JOIN journey_user_car_power b ON a.power_id = b.power_id
LEFT JOIN journey_node_info c ON a.node_id = c.node_id
LEFT JOIN apply_info d ON b.apply_id = d.apply_id
LEFT JOIN ecmp_user e ON e.user_id = c.user_id
LEFT JOIN car_info f  ON a.car_id=f.car_id
LEFT JOIN journey_info h on a.journey_id=h.journey_id
    </sql>

    <select id="selectOrderInfoList" parameterType="com.hq.ecmp.mscore.domain.OrderInfo" resultMap="OrderInfoResult">
        <include refid="selectOrderInfoVo"/>
        <where>
            <if test="journeyId != null "> and journey_id = #{journeyId}</if>
            <if test="companyId != null "> and company_id = #{companyId}</if>
            <if test="nodeId != null "> and node_id = #{nodeId}</if>
            <if test="powerId != null "> and power_id = #{powerId}</if>
            <if test="driverId != null "> and driver_id = #{driverId}</if>
            <if test="carId != null "> and car_id = #{carId}</if>
            <if test="userId != null "> and user_id = #{userId}</if>
            <if test="useCarMode != null  and useCarMode != ''"> and use_car_mode = #{useCarMode}</if>
            <if test="serviceType != null  and serviceType != ''"> and service_type = #{serviceType}</if>
            <if test="state != null  and state != ''"> and state = #{state}</if>
            <if test="tripartiteOrderId != null  and tripartiteOrderId != ''"> and tripartite_order_id = #{tripartiteOrderId}</if>
            <if test="tripartitePlatformCode != null  and tripartitePlatformCode != ''"> and tripartite_platform_code = #{tripartitePlatformCode}</if>
            <if test="driverName != null  and driverName != ''"> and driver_name like concat('%', #{driverName}, '%')</if>
            <if test="driverMobile != null  and driverMobile != ''"> and driver_mobile = #{driverMobile}</if>
            <if test="carLicense != null  and carLicense != ''"> and car_license = #{carLicense}</if>
            <if test="flightNumber != null  and flightNumber != ''"> and flight_number = #{flightNumber}</if>
            <if test="demandCarLevel != null "> and demand_car_level = #{demandCarLevel}</if>
        </where>
    </select>

    <select id="selectOrderInfoById" parameterType="Long" resultMap="OrderInfoResult">
        <include refid="selectOrderInfoVo"/>
        where order_id = #{orderId}
    </select>

    <insert id="insertOrderInfo" parameterType="com.hq.ecmp.mscore.domain.OrderInfo">
        <selectKey keyColumn="order_id" keyProperty="orderId" resultType="long" order="AFTER">
            select last_insert_id();
        </selectKey>
        insert into order_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="journeyId != null ">journey_id,</if>
            <if test="companyId != null ">company_id,</if>
            <if test="nodeId != null ">node_id,</if>
            <if test="powerId != null ">power_id,</if>
            <if test="driverId != null ">driver_id,</if>
            <if test="carId != null ">car_id,</if>
            <if test="userId != null ">user_id,</if>
            <if test="useCarMode != null  and useCarMode != ''">use_car_mode,</if>
            <if test="serviceType != null  and serviceType != ''">service_type,</if>
            <if test="state != null  and state != ''">state,</if>
            <if test="tripartiteOrderId != null  and tripartiteOrderId != ''">tripartite_order_id,</if>
            <if test="tripartitePlatformCode != null  and tripartitePlatformCode != ''">tripartite_platform_code,</if>
            <if test="driverName != null  and driverName != ''">driver_name,</if>
            <if test="driverMobile != null  and driverMobile != ''">driver_mobile,</if>
            <if test="carLicense != null  and carLicense != ''">car_license,</if>
            <if test="flightNumber != null  and flightNumber != ''">flight_number,</if>
            <if test="demandCarLevel != null and demandCarLevel != ''">demand_car_level,</if>
            <if test="createBy != null ">create_by,</if>
            <if test="createTime != null ">create_time,</if>
            <if test="updateBy != null ">update_by,</if>
            <if test="updateTime != null ">update_time,</if>
            <if test="orderNumber != null and orderNumber != ''">order_number,</if>
            <if test="carModel != null and carModel != ''">car_model,</if>
            <if test="carColor != null and carColor != ''">car_color,</if>
            <if test="driverGrade != null and driverGrade != ''">driver_grade,</if>
            <if test="flightPlanTakeOffTime != null ">flight_plan_take_off_time,</if>
            <if test="itIsSupplement != null ">it_is_supplement,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="journeyId != null ">#{journeyId},</if>
            <if test="companyId != null ">#{companyId},</if>
            <if test="nodeId != null ">#{nodeId},</if>
            <if test="powerId != null ">#{powerId},</if>
            <if test="driverId != null ">#{driverId},</if>
            <if test="carId != null ">#{carId},</if>
            <if test="userId != null ">#{userId},</if>
            <if test="useCarMode != null  and useCarMode != ''">#{useCarMode},</if>
            <if test="serviceType != null  and serviceType != ''">#{serviceType},</if>
            <if test="state != null  and state != ''">#{state},</if>
            <if test="tripartiteOrderId != null  and tripartiteOrderId != ''">#{tripartiteOrderId},</if>
            <if test="tripartitePlatformCode != null  and tripartitePlatformCode != ''">#{tripartitePlatformCode},</if>
            <if test="driverName != null  and driverName != ''">#{driverName},</if>
            <if test="driverMobile != null  and driverMobile != ''">#{driverMobile},</if>
            <if test="carLicense != null  and carLicense != ''">#{carLicense},</if>
            <if test="flightNumber != null  and flightNumber != ''">#{flightNumber},</if>
            <if test="demandCarLevel != null and demandCarLevel != '' ">#{demandCarLevel},</if>
            <if test="createBy != null ">#{createBy},</if>
            <if test="createTime != null ">#{createTime},</if>
            <if test="updateBy != null ">#{updateBy},</if>
            <if test="updateTime != null ">#{updateTime},</if>
            <if test="orderNumber != null and orderNumber != ''">#{orderNumber},</if>
            <if test="carModel != null and carModel != ''">#{carModel},</if>
            <if test="carColor != null and carColor != ''">#{carColor},</if>
            <if test="driverGrade != null and driverGrade != ''">#{driverGrade},</if>
            <if test="flightPlanTakeOffTime != null ">#{flightPlanTakeOffTime},</if>
            <if test="itIsSupplement != null ">#{itIsSupplement},</if>
        </trim>
    </insert>

    <update id="updateOrderInfo" parameterType="com.hq.ecmp.mscore.domain.OrderInfo">
        update order_info
        <trim prefix="SET" suffixOverrides=",">
            <if test="journeyId != null ">journey_id = #{journeyId},</if>
            <if test="nodeId != null ">node_id = #{nodeId},</if>
            <if test="powerId != null ">power_id = #{powerId},</if>
            <if test="driverId != null ">driver_id = #{driverId},</if>
            <if test="carId != null ">car_id = #{carId},</if>
            <if test="userId != null ">user_id = #{userId},</if>
            <if test="useCarMode != null  and useCarMode != ''">use_car_mode = #{useCarMode},</if>
            <if test="serviceType != null  and serviceType != ''">service_type = #{serviceType},</if>
            <if test="state != null  and state != ''">state = #{state},</if>
            <if test="tripartiteOrderId != null  and tripartiteOrderId != ''">tripartite_order_id = #{tripartiteOrderId},</if>
            <if test="tripartitePlatformCode != null  and tripartitePlatformCode != ''">tripartite_platform_code = #{tripartitePlatformCode},</if>
            <if test="driverName != null  and driverName != ''">driver_name = #{driverName},</if>
            <if test="driverMobile != null  and driverMobile != ''">driver_mobile = #{driverMobile},</if>
            <if test="carLicense != null  and carLicense != ''">car_license = #{carLicense},</if>
            <if test="flightNumber != null  and flightNumber != ''">flight_number = #{flightNumber},</if>
            <if test="demandCarLevel != null ">demand_car_level = #{demandCarLevel},</if>
            <if test="createBy != null ">create_by = #{createBy},</if>
            <if test="createTime != null ">create_time = #{createTime},</if>
            <if test="updateBy != null ">update_by = #{updateBy},</if>
            <if test="updateTime != null ">update_time = #{updateTime},</if>
            <if test="orderNumber != null ">order_number = #{orderNumber},</if>
            <if test="carModel != null and carModel != ''">car_model =#{carModel},</if>
            <if test="carColor != null and carColor != ''">car_color =#{carColor},</if>
            <if test="driverGrade != null and driverGrade != ''">driver_grade =#{driverGrade},</if>
            <if test="itIsSupplement != null and itIsSupplement != ''">it_is_supplement =#{itIsSupplement},</if>
        </trim>
        where order_id = #{orderId}
    </update>
    <update id="updateOrderInfoNull" parameterType="com.hq.ecmp.mscore.domain.OrderInfo">
        update order_info
        <trim prefix="SET" suffixOverrides=",">
            <if test="journeyId != null ">journey_id = #{journeyId},</if>
            <if test="nodeId != null ">node_id = #{nodeId},</if>
            <if test="powerId != null ">power_id = #{powerId},</if>
            driver_id = #{driverId},
            car_id = #{carId},
            <if test="userId != null ">user_id = #{userId},</if>
            <if test="useCarMode != null  and useCarMode != ''">use_car_mode = #{useCarMode},</if>
            <if test="serviceType != null  and serviceType != ''">service_type = #{serviceType},</if>
            <if test="state != null  and state != ''">state = #{state},</if>
            <if test="tripartiteOrderId != null  and tripartiteOrderId != ''">tripartite_order_id = #{tripartiteOrderId},</if>
            <if test="tripartitePlatformCode != null  and tripartitePlatformCode != ''">tripartite_platform_code = #{tripartitePlatformCode},</if>
            <if test="driverName != null  and driverName != ''">driver_name = #{driverName},</if>
            <if test="driverMobile != null  and driverMobile != ''">driver_mobile = #{driverMobile},</if>
            <if test="carLicense != null  and carLicense != ''">car_license = #{carLicense},</if>
            <if test="flightNumber != null  and flightNumber != ''">flight_number = #{flightNumber},</if>
            <if test="demandCarLevel != null ">demand_car_level = #{demandCarLevel},</if>
            <if test="createBy != null ">create_by = #{createBy},</if>
            <if test="createTime != null ">create_time = #{createTime},</if>
            <if test="updateBy != null ">update_by = #{updateBy},</if>
            <if test="updateTime != null ">update_time = #{updateTime},</if>
            <if test="orderNumber != null ">order_number = #{orderNumber},</if>
            <if test="carModel != null and carModel != ''">car_model =#{carModel},</if>
            <if test="carColor != null and carColor != ''">car_color =#{carColor},</if>
            <if test="driverGrade != null and driverGrade != ''">driver_grade =#{driverGrade},</if>
        </trim>
        where order_id = #{orderId}
    </update>
    <delete id="deleteOrderInfoById" parameterType="Long">
        delete from order_info where order_id = #{orderId}
    </delete>

    <delete id="deleteOrderInfoByIds" parameterType="String">
        delete from order_info where order_id in
        <foreach item="orderId" collection="array" open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </delete>

    <select id="getOrderList" parameterType="Long"  resultType="com.hq.ecmp.mscore.domain.OrderListInfo">
        select * from (
        select
            o.order_id orderId,
            o.it_is_supplement  itIsSupplement,
            opi.state payState,
            ecti.`level`,
            o.use_car_mode useCarMode,
            o.state,
            jn.service_type serviceType,
            IFNULL(oai.action_time,jni.plan_setout_time) setOutTime,
            IFNULL(oai.address,jni.plan_begin_address) setOutAddress,
            IFNULL(oai2.address,jni.plan_end_address) arriveAddress,
            o.order_number orderNumber,
            (select state from order_state_trace_info sti where sti.order_id=o.order_id order by trace_id desc limit 1) labelState
            from order_info o
            left join journey_info jn on o.journey_id=jn.journey_id
            LEFT  join order_pay_info opi on o.order_id = opi.order_id
            left join journey_node_info jni on  jni.node_id=o.node_id
            left join car_info ci on ci.car_id=o.car_id
            left join enterprise_car_type_info ecti on ecti.car_type_id=ci.car_type_id
						left join order_address_info oai on oai.order_id=o.order_id and oai.type='A000'
						left join order_address_info oai2 on oai2.order_id=o.order_id and oai2.type='A999'
            where jn.user_id=#{userId}
            and o.state in('S200','S299','S500','S600','S616','S699','S900')
        order by o.create_time  desc
         )cc1 where cc1.labelState not in ('S930','S921')
    </select>


    <select id="queryOrderRelateInfo" parameterType="com.hq.ecmp.mscore.domain.OrderInfo" resultType="com.hq.ecmp.mscore.domain.DispatchOrderInfo">
    SELECT
	a.order_id AS orderId,
	a.state,
	a.create_time as createTime,
	a.driver_name as driverName,
	a.car_license as carLicense,
	a.car_model as carType,
	d.apply_type AS applyType,
	d.update_time as applyPassDate,
	b.type AS serverType,
	c.plan_begin_address AS useCarCity,
	e.nick_name AS applyUserName,
	e.nick_name AS useCarUserName,
<!-- 	a.actual_setout_address AS startSite,
	a.actual_setout_time AS useCarDate,
	a.actual_arrive_address AS endSite,
	a.actual_arrive_time AS endDate, -->
	h.use_car_mode AS useCarMode,
	h.regimen_id AS regimenId
	<if test="orderTraceState != null  and orderTraceState != ''">
	    ,f.content as reassignmentApplyReason,f.create_time as updateDate
	</if>
FROM
	order_info a
LEFT JOIN journey_user_car_power b ON a.power_id = b.power_id
LEFT JOIN journey_node_info c ON a.node_id = c.node_id
LEFT JOIN journey_info h ON h.journey_id=a.journey_id
LEFT JOIN apply_info d ON b.apply_id = d.apply_id
LEFT JOIN ecmp_user e ON e.user_id = c.user_id
<if test="orderTraceState != null  and orderTraceState != ''">LEFT JOIN order_state_trace_info f on a.order_id=f.order_id</if>
 <where>
            <if test="state != null  and state != ''"> and a.state = #{state}</if>
             <if test="orderTraceState != null  and orderTraceState != ''"> and f.state = #{orderTraceState}</if>
              <if test="companyId != null"> and a.company_id = #{companyId}</if>
        </where>
         GROUP BY a.order_id
    </select>



    <select id="getDriverOrderList" parameterType="java.lang.Long" resultType="com.hq.ecmp.mscore.domain.OrderDriverListInfo">
        select
            o.order_id orderId,
            o.state,
            if (o.state='S900','已完成','未完成') stateType,
            o.service_type serviceType,
            o.flight_number flightNumber,
            jn.use_time useTime,
            jn.it_is_return itIsReturn,
            jn.charter_car_type charterCarType,
            s.action_time useCarTime,
            s.address startAddr,
            DATE_FORMAT(jn.start_date, '%Y-%m-%d %H:%i') startDate,
            DATE_FORMAT(jn.end_date, '%Y-%m-%d %H:%i') endDate,
            t.address endAddr,
            IF (
            o.driver_id =#{driverId},
            ( SELECT state FROM order_state_trace_info sti WHERE sti.order_id = o.order_id ORDER BY trace_id DESC LIMIT 1 ),
            'S279'
            ) labelState,
            o.driver_id  driverId
        from order_info o
        left join journey_info jn on o.journey_id=jn.journey_id
        left join order_address_info s on s.order_id=o.order_id and s.type='A000'
        left join order_address_info t on t.order_id=o.order_id and t.type='A999'
        where (o.driver_id=#{driverId} OR
                 o.order_id IN ( SELECT order_id FROM order_state_trace_info st WHERE st.create_by =#{driverId} AND st.state = 'S270'
        ))
        <if test="flag==1">
            and (o.state='S299' or o.state='S500' or o.state='S600' or o.state='S616' or o.state='S635'  )
            order by useCarTime asc
        </if>
        <if test="flag==0">
            and (o.state='S299' or o.state='S500' or o.state='S600' or o.state='S616' or o.state='S699' or o.state='S635' or
            o.state='S900' )
            ORDER BY
            o.state = 'S900' asc, labelState = 'S279' asc,
            CASE WHEN  (o.state = 'S900' or  labelState = 'S279')  THEN o.update_time END DESC,
            useCarTime ASC
        </if>
    </select>

    <select id="getDriverOrderListCount" resultType="int">
        select count(*) from order_info
        where (driver_id=#{driverId} OR
                 order_id IN ( SELECT order_id FROM order_state_trace_info st WHERE st.create_by =#{driverId} AND st.state = 'S270'
        )) and find_in_set(state,#{states})
    </select>

    <select id="selectOrderDetail" parameterType="Object" resultType="com.hq.ecmp.mscore.vo.DriverOrderInfoVO">
        	select
             o.order_id orderId,
             o.journey_id journeyId,
             o.state,
             o.driver_id driverId,
             o.service_type serviceType,
             jn.flight_number flightNumber,
             jn.it_is_return itIsReturn,
             jn.charter_car_type charterCarType,

             jn.start_date startDate,
             jn.end_date endDate,

             jn.use_time useTime,
             org.dept_name deptName,
             g.telephone groupPhone,
             u.mobile driverPhone,
             p.peer_number peerNumber,
			 e.image_url imageUrl,

             s.action_time useCarTime,
             s.address startAddr,
             t.address endAddr,
             DATE_FORMAT(jn.start_date, '%Y-%m-%d %H:%i') startDate,
             DATE_FORMAT(jn.end_date, '%Y-%m-%d %H:%i') endDate,
             t.action_time endTime,
             c.car_license carLicense,
             c.car_color carColor,
             c.car_type carType,
             o.user_id userId,
             (select state from order_state_trace_info sti where sti.order_id=o.order_id order by trace_id desc limit 1) labelState,
             (select group_concat(short_address) from order_via_info f where f.order_id=o.order_id) halfway,
             (select count(*) from journey_passenger_info where journey_id=o.journey_id) peopleCount
            from order_info o

            left join journey_info jn on o.journey_id=jn.journey_id
            left join order_address_info s on  s.order_id=o.order_id and s.type='A000'
            left join order_address_info t on  t.order_id=o.order_id and t.type='A999'
            left join car_info c on c.car_id=o.car_id
            left join ecmp_org org on c.dept_id = org.dept_id
            left join car_group_info g on c.car_group_id = g.car_group_id
            left join driver_info u  on o.driver_id = u.driver_id
            left join journey_passenger_info p on jn.journey_id = p.journey_id
			left join enterprise_car_type_info e on  c.car_type_id = e.car_type_id
            where o.order_id=#{orderId}
    </select>

    <select id="driverOrderUndoneList" parameterType="java.lang.Long" resultType="com.hq.ecmp.mscore.domain.OrderDriverListInfo">
        	select
					 o.order_id orderId,
					 o.state,
					 '未完成' stateType,
                     o.service_type serviceType,
					 o.flight_number flightNumber,
					 jn.it_is_return itIsReturn,

                     jn.use_time useTime,
                     jn.start_date startDate,
                     jn.end_date endDate,

					 jn.charter_car_type charterCarType,
					 s.action_time useCarTime,
					 s.address startAddr,
                     t.address endAddr,
                    (select state from order_state_trace_info sti where sti.order_id=o.order_id order by trace_id desc limit 1) labelState
				from order_info o
                left join journey_info jn on o.journey_id=jn.journey_id
                left join order_address_info s on  s.order_id=o.order_id and s.type='A000'
                left join order_address_info t on  t.order_id=o.order_id and t.type='A999'
				where o.driver_id=#{driverId} and  (o.state="S299" or o.state="S600" or o.state="S616" )
                <if test="day!=-1">
                    <![CDATA[AND DATE_FORMAT(s.action_time, '%Y-%m-%d')  <= DATE_FORMAT(DATE_ADD(now() ,INTERVAL #{day} DAY), '%Y-%m-%d') ]]>
                    <![CDATA[AND DATE_FORMAT(t.action_time, '%Y-%m-%d') >= DATE_FORMAT(now(), '%Y-%m-%d') ]]>
                </if>
                order by s.action_time asc
    </select>


	<select id="queryCompleteDispatchOrder" resultType="com.hq.ecmp.mscore.domain.DispatchOrderInfo">
		 SELECT
            a.order_id AS orderId,
            a.state,
            a.demand_car_level as demandCarLevel,
            d.apply_type AS applyType,
            b.type AS serverType,
            c.plan_begin_address AS useCarCity,
            c.plan_begin_city_code as useCarCityCode,
            e.nick_name AS applyUserName,
            e.nick_name AS useCarUserName,
            a.use_car_mode AS useCarMode,
            a.driver_name AS driverName,
            a.driver_mobile AS driverTel,
            f.car_type as carType,
            f.car_license AS carLicense,
            h.regimen_id as regimenId,
            m.create_time as updateDate,
            d.apply_id as applyId
        FROM
            order_info a
        LEFT JOIN journey_user_car_power b ON a.power_id = b.power_id
        LEFT JOIN journey_node_info c ON a.node_id = c.node_id
        LEFT JOIN apply_info d ON b.apply_id = d.apply_id
        LEFT JOIN ecmp_user e ON e.user_id = c.user_id
        LEFT JOIN car_info f  ON a.car_id=f.car_id
        LEFT JOIN journey_info h on a.journey_id=h.journey_id
        LEFT JOIN order_state_trace_info m on a.order_id=m.order_id
        where a.state in ('S200','S299','S600','S616','S699','S900')  and m.state in ('S299','S279','S200')
        GROUP BY a.order_id
	</select>

	<select id="getOrderState" resultType="com.hq.ecmp.mscore.vo.OrderStateVO">
		select
		a.order_id AS orderId,
		a.journey_id journeyId,
	    a.state,
	    a.service_type serviceType,
	    a.user_id userId,
	    a.driver_id driverId,
	    a.use_car_mode useCarMode,
	    a.driver_mobile driverPhone,
        e.address startAddress,
        DATE_FORMAT(e.action_time, '%m月%d日 %H:%i ') useCarTime,
        e.action_time useCarDate,
        e.longitude startLongitude,
        e.latitude startLatitude,
        d.address endAddress,
        d.longitude endLongitude ,
        d.latitude endLatitude,
        g.charter_car_type charterCarType,

        g.use_time useTime,
        g.start_date startDate,
        g.end_date endDate,

        (select state from order_state_trace_info sti where sti.order_id=#{orderId} order by SUBSTRING(sti.state,1) desc limit 1) labelState
	    from order_info a
	        left join journey_info g on g.journey_id=a.journey_id
            left join order_address_info e on e.order_id=a.order_id and e.type='A000'
            left join order_address_info d on d.order_id=a.order_id and d.type='A999'
		where a.order_id=#{orderId}
	</select>

    <select id="getWaitDispatchOrderDetailInfo" parameterType="java.lang.Long" resultType="com.hq.ecmp.mscore.domain.DispatchOrderInfo">
       SELECT
            a.order_id AS orderId,
            a.state,
            a.create_time as createTime,
            d.apply_type AS applyType,
            d.apply_id as applyId,
            b.type AS serverType,
            c.plan_begin_address AS useCarCity,
            c.node_id as nodeId,
            e.nick_name AS applyUserName,
            e.nick_name AS useCarUserName,
            e.phonenumber AS applyUserTel,
        <!-- 	a.actual_setout_address AS startSite,
            a.actual_setout_time AS useCarDate,
            a.actual_arrive_address AS endSite,
            a.actual_arrive_time AS endDate, -->
            h.use_car_mode AS useCarMode,
            h.regimen_id as regimenId,
            h.it_is_return as itIsReturn,
            h.wait_time_long as waitTimeLong,
            h.journey_id as journeyId
        FROM
            order_info a
        LEFT JOIN journey_user_car_power b ON a.power_id = b.power_id
        LEFT JOIN journey_node_info c ON a.node_id = c.node_id
        LEFT JOIN journey_info h ON h.journey_id=a.journey_id
        LEFT JOIN apply_info d ON b.apply_id = d.apply_id
        LEFT JOIN ecmp_user e ON e.user_id = c.user_id
         where a.order_id=#{orderId}
    </select>

	<select id="queryCompleteDispatchOrderDetail" parameterType="java.lang.Long"
		resultType="com.hq.ecmp.mscore.domain.DispatchOrderInfo">
		<include refid="queryDispatchAchieve" />
		where a.order_id=#{orderId}
	</select>


    <select id="getOrderMessage" parameterType="Object" resultType="com.hq.ecmp.mscore.dto.MessageDto">
         SELECT messageId,messageType,messageTypeStr,count(*) messageCount from (
            select order_id as messageId
             <if test="userId!=null and driveId==null">
                 ,4 as messageType,'派车'as messageTypeStr
             </if>
            <if test="driveId!=null and userId==null">
                 ,1 as messageType,'新任务'as messageTypeStr
             </if>
             from order_info
            where find_in_set(state,#{states})
            <if test="driveId!=null and userId==null">
            and driver_id=#{driveId}
            </if>
            ) a group by a.messageType
    </select>

    <select id="getNextTaskWithDriver" parameterType="java.lang.Long" resultType="com.hq.ecmp.mscore.domain.OrderDriverListInfo">
       select
        o.order_id orderId,
        o.journey_id journeyId,
        o.state,
        o.car_id carId,
        o.driver_id driverId,
        jn.service_type serviceType,
        IFNULL(o.flight_number,jn.flight_number) flightNumber,
        jn.it_is_return itIsReturn,
        jn.charter_car_type charterCarTye,
        DATE_FORMAT(IFNULL(oai.action_time,jni.plan_setout_time),'%Y-%m-%d %H:%i') useCarTime,
        IFNULL(oai.address,jni.plan_begin_address) startAddr,
        IFNULL(oai2.address,jni.plan_end_address) endAddr
        from order_info o
        left join journey_info jn on o.journey_id=jn.journey_id
        left join journey_node_info jni on jni.node_id=o.node_id
		left join order_address_info oai on oai.order_id=o.order_id and oai.type='A000'
		left join order_address_info oai2 on oai2.order_id=o.order_id and oai2.type='A999'
        where  (hour(timediff(IFNULL(oai.action_time,jni.plan_setout_time),now()))+minute(timediff(IFNULL(oai.action_time,jni.plan_setout_time),now()))/60)&lt;=2
        and o.state='S299'
        and o.driver_id=#{driverId}
         order by IFNULL(oai.action_time,jni.plan_setout_time) asc
        limit 0,1

    </select>
    <select id="getNextTaskWithCar" parameterType="java.lang.Long" resultType="com.hq.ecmp.mscore.domain.OrderDriverListInfo">
     	 select
        o.order_id orderId,
        o.journey_id journeyId,
        o.state,
        o.car_id carId,
        o.driver_id driverId,
        jn.service_type serviceType,
        IFNULL(o.flight_number,jn.flight_number) flightNumber,
        jn.it_is_return itIsReturn,
        jn.charter_car_type charterCarTye,
        DATE_FORMAT(IFNULL(oai.action_time,jni.plan_setout_time),'%Y-%m-%d %H:%i') useCarTime,
        IFNULL(oai.address,jni.plan_begin_address) startAddr,
        IFNULL(oai2.address,jni.plan_end_address) endAddr
        from order_info o
        left join journey_info jn on o.journey_id=jn.journey_id
        left join journey_node_info jni on jni.node_id=o.node_id
		left join order_address_info oai on oai.order_id=o.order_id and oai.type='A000'
		left join order_address_info oai2 on oai2.order_id=o.order_id and oai2.type='A999'
        where  (hour(timediff(IFNULL(oai.action_time,jni.plan_setout_time),now()))+minute(timediff(IFNULL(oai.action_time,jni.plan_setout_time),now()))/60)&lt;=2
        and o.state='S299'
        and o.car_id=#{carId}
        order by IFNULL(oai.action_time,jni.plan_setout_time) asc
        limit 0,1;
</select>


    <select id="getCancelOrderMessage" parameterType="Object" resultType="com.hq.ecmp.mscore.dto.MessageDto">
         SELECT messageId,messageType,'取消任务' messageTypeStr,count(*) messageCount from (
            select order_id as messageId,4 as messageType from order_info
            where state=#{state} and driver_id=#{driverId}
            ) a group by a.messageType
    </select>

    <select id="getDriverOrderCount" parameterType="Object" resultType="int">
        select count(*) from order_info
        where find_in_set(state,#{states}) and driver_id=#{driverId}
    </select>

    <select id="getOrderListBackDto" parameterType="com.hq.ecmp.mscore.dto.OrderListBackDto" resultType="com.hq.ecmp.mscore.dto.OrderListBackDto">
        select
        s.company_id companyId,
        -- 申请人姓名
        eu.nick_name applyName,
        -- 申请人所属部门/公司
        eo.dept_name deptName,
        -- 申请人手机号
        eu.phonenumber applyPhoneNumber,
        -- 乘车人
        jpi.name passengerName,
        -- 乘车人电话
        jpi.mobile passengerMobile,
        -- 同行人
        jpi.peer_number peerName,
        -- 实际用车时间
        oai.action_time beginTime,
        -- 实际下车时间
        oai2.action_time endTime,
        -- 实际上车地址
        oai.address  beginAddress,
        -- 实际下车地址
        oai2.address endAddress,
        -- 服务类型 1000预约  2001接机 2002送机 3000包车
        s.service_type serviceType,
        -- 包车类型  T000  非包车 T001 半日租（4小时） T002 整日租（8小时）
        ji.charter_car_type  charterCarType,
        -- 用车时间
        ji.use_car_time,
        -- 用车方式 自有车   W100 网约车   W200
        s.use_car_mode useCarMode,
        -- 订单id
        s.order_id orderId,
        -- 订单状态
        s.state orderState,
        -- 费用合计
        CONVERT(osi.amount,DECIMAL(10,2))  amount,
        -- 订单编号
        s.order_number orderNumber,
        -- 轨迹状态
        (select state from order_state_trace_info sti where sti.order_id=s.order_id order by trace_id desc limit 1) labelState,
        (select  oddi.it_is_self_driver from order_dispatche_detail_info oddi where  oddi.order_id=s.order_id) itIsSelfDriver,
        -- 用车制度
        ri.name regimenName,

        s.create_by createBy,
        s.it_is_supplement itIsSupplement
        from order_info s
        LEFT join journey_user_car_power jucp on jucp.power_id=s.power_id
        LEFT join apply_info a on a.apply_id=jucp.apply_id
        LEFT join ecmp_user eu on eu.user_id=a.create_by
        LEFT join journey_info ji on ji.journey_id=s.journey_id
        LEFT join regime_info ri on ri.regimen_id=ji.regimen_id
        LEFT join journey_passenger_info jpi on jpi.journey_id=s.journey_id
        LEFT join order_settling_info osi on osi.order_id=s.order_id
        left join order_address_info oai on oai.order_id=s.order_id and oai.type='A000'
        left join order_address_info oai2 on oai2.order_id=s.order_id and oai2.type='A999'
        left join ecmp_org eo on eu.dept_id = eo.dept_id
            <where>
                <if test="applyName != null and  applyName!=''"> and eu.nick_name like concat('%',#{applyName},'%') </if>
                <if test="applyPhoneNumber != null and  applyPhoneNumber!='' "> and eu.phonenumber like concat('%',#{applyPhoneNumber},'%') </if>
                <if test="passengerName != null and  passengerName!='' "> and  jpi.name = #{passengerName}</if>
                <if test="orderNumber != null and  orderNumber!='' "> and  s.order_number = #{orderNumber}</if>
                <if test="serviceType != null and  serviceType!='' "> and ji.service_type = #{serviceType}</if>
                <if test="useCarMode != null and  useCarMode!=''"> and s.use_car_mode = #{useCarMode}</if>
                <if test="charterCarType != null and  charterCarType!='' "> and  ji.charter_car_type = #{charterCarType}</if>
                <if test="useCarTimeBegin != null and  useCarTimeBegin!='' "> and DATE_FORMAT(ji.use_car_time,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{useCarTimeBegin},'%Y-%m-%d %H:%i:%S')</if>
                <if test="useCarTimeEnd != null and  useCarTimeEnd!='' "> and DATE_FORMAT(ji.use_car_time,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{useCarTimeEnd},'%Y-%m-%d %H:%i:%S')</if>
                <if test="orderState != null and  orderState!='' "> and s.state = #{orderState}</if>
                <if test="orderId != null and  orderId!=''"> and s.order_id  like concat('%',#{orderId},'%') </if>
                <if test="state == 1">
                    and s.state  in ('S911','S900','S699','S616','S600','S500','S299')
                </if>
                <if test="state == 2">
                    and s.state  in ('S699','S616','S600','S500','S299')
                </if>
                <if test="null != companyId and companyId !=''">
                    and s.company_id = #{companyId}
                </if>
                <if test="null != userId and userId !=''">
                    and s.create_by = #{userId}
                </if>
                <if test="null != updateBy and updateBy !=''">
                    and s.car_id in (
                        select car_id  from car_info where car_group_id in
                        (select car_group_id from car_group_dispatcher_info where user_id=#{updateBy})
                    )
                </if>
            </where>
            group by s.order_id
            order by a.create_time desc
    </select>

    <select id="getOrderListDetail" parameterType="java.lang.Long" resultType="com.hq.ecmp.mscore.dto.OrderDetailBackDto">
        select
        si.name sceneName,
        srr.scene_id sceneId,
        s.order_id orderId,
        s.order_number orderNumber,
        eu.nick_name applyName,
        eu.phonenumber applyPhoneNumber,
        eo.dept_name deptName,
        ri.name regimenName,
        jpi.name passengerName,
        jpi.mobile passengerMobile,
        jpi.peer_number peerName,
        s.use_car_mode useCarMode,
        dif.driver_name driverName,
        dif.mobile driverPhone,
        ifnull(s.car_model,ci.car_type) carType,
        ifnull(s.car_color,ci.car_color) carColor,
        ifnull(s.car_license,ci.car_license) carLicense,
        s.state orderState,
        jni.plan_setout_time useCarTime,
        jni.plan_begin_address planningSetOutAddress,
        jni.plan_arrive_time planningArriveTime,
        jni.plan_end_address planningArriveAddress,
        oai.action_time beginTime,
        oai2.action_time endTime,
        oai.address beginAddress,
        oai2.address endAddress,
        s.service_type serviceType,
        ji.charter_car_type charterCarType,
        ifnull(ecti.name,s.demand_car_level) carLevel,
        CONVERT(osi.total_mileage,DECIMAL(10,2)) totalMileage,
        osi.total_time totalTime,
        osi.amount_detail amountDetail,
        CONVERT(osi.amount,DECIMAL(10,2)) amount,
        dhi.longitude currentLongitude,
        dhi.latitude currentLatitude,
        (select notes from apply_info where journey_id=ji.journey_id)notes,
        (select reason from apply_info where journey_id=ji.journey_id)reason,
        (select car_group_name   from car_group_info where car_group_id= ci.car_group_id)carGroupName,
        (select car_group_name   from car_group_info where car_group_id in
                    (select car_group_id from car_group_driver_relation where driver_id=s.driver_id)
        )driverGroupName,
        (select state from order_state_trace_info sti where sti.order_id=s.order_id order by trace_id desc limit 1) labelState
        from order_info s
        left join journey_user_car_power jucp on jucp.power_id=s.power_id
        left join apply_info a on a.apply_id=jucp.apply_id
        left join driver_info dif on dif.driver_id=s.driver_id
        left join ecmp_user eu on eu.user_id=a.create_by
        left join journey_info ji on ji.journey_id=s.journey_id
        left join journey_passenger_info jpi on jpi.journey_id=s.journey_id
        left join order_settling_info osi on osi.order_id=s.order_id
        left join ecmp_org eo on eo.dept_id=eu.dept_id
        left join car_info ci on ci.car_id=s.car_id
        left join journey_node_info jni on jni.node_id=jucp.node_id
        left join enterprise_car_type_info ecti on ecti.car_type_id=ci.car_type_id
        left join regime_info ri on ri.regimen_id=ji.regimen_id
        left join scene_regime_relation srr on srr.regimen_id = ri.regimen_id
        left join scene_info si on si.scene_id = srr.scene_id
        left join order_address_info oai on oai.order_id=s.order_id and oai.type='A000'
        left join order_address_info oai2 on oai2.order_id=s.order_id and oai2.type='A999'
        left join ( select d1.* from driver_heartbeat_info d1,
        (select dd.driver_id,dd.order_id,max(dd.create_time) mtime from driver_heartbeat_info dd
        group by dd.driver_id,dd.order_id) d2
        where d1.driver_id=d2.driver_id and d1.order_id=d2.order_id and d1.create_time=d2.mtime ) dhi
        on dhi.driver_id=s.driver_id and dhi.order_id=s.order_id
        <where>
                s.order_id=#{orderId}
            </where>
    </select>

	<select id="queryApplyDispatchList" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery"
		resultType="com.hq.ecmp.mscore.vo.ApplyDispatchVo">
		SELECT
		a.order_id AS orderId,
		b.nick_name AS applyUserName,
		b.user_name AS applyUserMobile,
		a.journey_id AS journeyId,
		a.node_id AS nodeId,
		a.update_time AS optDate,
		a.state AS state,
		a.service_type as serviceType,
		h.it_is_return as itIsReturn,
		h.wait_time_long as waitTimeLong,
		f.SHORT_NAME as cityName
		FROM
		order_info a
		LEFT JOIN order_state_trace_info d ON a.order_id = d.order_id
		LEFT JOIN ecmp_user b ON a.user_id = b.user_id
		LEFT JOIN order_address_info c ON a.order_id = c.order_id
		LEFT JOIN journey_info h on a.journey_id=h.journey_id
		LEFT JOIN china_city f  ON c.city_postal_code =f.CITY_CODE
		WHERE
		d.state NOT IN ('S270', 'S277', 'S279') AND a.state in ('S100','S199','S299','S500','S600','S616','S699','S900')
		and (a.use_car_mode is null or a.use_car_mode='W100' or a.use_car_mode='' or a.use_car_mode='W200') and a.company_id=#{companyId}
		<if test="null !=applyMobile and applyMobile !=''">
			and b.user_name LIKE concat('%',#{applyMobile},'%')
		</if>
		<if test="null !=applyName and applyName !=''">
		 AND b.nick_name LIKE concat('%',#{applyName},'%')
		</if>
		<if test="null !=cityCode and cityCode !=''">
			AND c.city_postal_code = #{cityCode}
		</if>
		<if test="null !=optStartDate and optStartDate !=''">
			AND a.update_time &gt;= #{optStartDate}
		</if>
		<if test="null !=optEndDate and optEndDate !=''">
			AND a.update_time &lt;= #{optEndDate}
		</if>
		<if test="null !=useCarMode and useCarMode !=''">
			AND a.use_car_mode = #{useCarMode}
		</if>
		GROUP BY d.order_id
	</select>

   <select id="queryApplyDispatchListCount" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery" resultType="java.lang.Integer">
   select count(1) from
   (SELECT
		count(1)
		FROM
		order_info a
		LEFT JOIN order_state_trace_info d  ON a.order_id = d.order_id
		LEFT JOIN ecmp_user b ON a.user_id = b.user_id
		LEFT JOIN order_address_info c ON a.order_id = c.order_id
		WHERE
		d.state NOT IN ('S270', 'S277', 'S279') AND a.state in ('S100','S199','S299','S500','S600','S616','S699','S900')
		and (a.use_car_mode is null or a.use_car_mode='W100' or a.use_car_mode='')
		<if test="null !=applyMobile and applyMobile  !=''">
			and b.user_name LIKE concat('%',#{applyMobile},'%')
		</if>
		<if test="null !=applyName and applyName !=''">
			 AND b.nick_name LIKE concat('%',#{applyName},'%')
		</if>
		<if test="null !=cityCode and cityCode !=''">
			AND c.city_postal_code = #{cityCode}
		</if>
		<if test="null !=optStartDate and optStartDate !=''">
			AND a.update_time &gt;= #{optStartDate}
		</if>
		<if test="null !=optEndDate and optEndDate !=''">
			AND a.update_time &lt;= #{optEndDate}
		</if>
		<if test="null !=useCarMode and useCarMode !=''">
			AND a.use_car_mode = #{useCarMode}
		</if>
		GROUP BY d.order_id
		) m
   </select>

	<select id="queryReassignmentDispatchList" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery"
		resultType="com.hq.ecmp.mscore.vo.ApplyDispatchVo">
		SELECT
		a.order_id AS orderId,
		b.driver_name AS applyUserName,
		b.mobile AS applyUserMobile,
		a.journey_id AS journeyId,
		a.node_id AS nodeId,
		a.update_time AS optDate,
		a.state AS state,
		h.it_is_return as itIsReturn,
		h.wait_time_long as waitTimeLong,
		f.SHORT_NAME as cityName
		FROM
		order_info a
		LEFT JOIN order_state_trace_info d ON a.order_id = d.order_id
		LEFT JOIN driver_info b ON a.driver_id = b.driver_id
		LEFT JOIN order_address_info c ON a.order_id = c.order_id
		LEFT JOIN journey_info h on a.journey_id=h.journey_id
		LEFT JOIN china_city f  ON c.city_postal_code =f.CITY_CODE
		WHERE
		d.state IN ('S270', 'S277', 'S279') and a.state in
		('S299','S500','S600','S616','S900','S699') and a.use_car_mode is not null
		<if test="null !=driverMobile and driverMobile !=''">
			and b.mobile LIKE concat('%',#{driverMobile},'%')
		</if>
		<if test="null !=driverName and driverName !=''">
			 AND b.driver_name LIKE concat('%',#{driverName},'%')
		</if>
		<if test="null !=cityCode and cityCode !=''">
			AND c.city_postal_code = #{cityCode}
		</if>
		<if test="null !=optStartDate and optStartDate !=''">
			AND a.update_time &gt;= #{optStartDate}
		</if>
		<if test="null !=optEndDate and optEndDate !=''">
			AND a.update_time &lt;= #{optEndDate}
		</if>
		<if test="null !=useCarMode and useCarMode !=''">
			AND a.use_car_mode = #{useCarMode}
		</if>
		GROUP BY d.order_id
	</select>

	<select id="queryReassignmentDispatchListCount" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery"
		resultType="java.lang.Integer">
		select count(1) from
		(SELECT
		count(1)
		FROM
		order_info a
		LEFT JOIN order_state_trace_info d  ON a.order_id = d.order_id
		LEFT JOIN driver_info b ON a.driver_id = b.driver_id
		LEFT JOIN order_address_info c ON a.order_id = c.order_id
		WHERE
		d.state IN ('S270', 'S277', 'S279') and a.state in
		('S299','S500','S600','S616','S900','S699') and a.use_car_mode is not null
		<if test="null !=driverMobile and driverMobile !=''">
			and b.mobile LIKE concat('%',#{driverMobile},'%')
		</if>
		<if test="null !=driverName and driverName !=''">
			 AND b.driver_name LIKE concat('%',#{driverName},'%')
		</if>
		<if test="null !=cityCode and cityCode !=''">
			AND c.city_postal_code = #{cityCode}
		</if>
		<if test="null !=optStartDate and optStartDate !=''">
			AND a.update_time &gt;= #{optStartDate}
		</if>
		<if test="null !=optEndDate and optEndDate !=''">
			AND a.update_time &lt;= #{optEndDate}
		</if>
		<if test="null !=useCarMode and useCarMode !=''">
			AND a.use_car_mode = #{useCarMode}
		</if>
		GROUP BY d.order_id
		) m
	</select>

    <select id="selectDriverOrder" parameterType="Object" resultType="com.hq.ecmp.mscore.domain.OrderInfo">
        select a.order_id orderId,use_car_mode useCarMode from order_info a
            inner join order_address_info b on b.order_id=a.order_id
        where a.driver_id=#{driverId} AND  a.state=#{state}
        <![CDATA[AND DATE_FORMAT(b.action_time, '%Y-%m-%d %H:%i:%s') <= DATE_FORMAT(DATE_ADD(now() ,INTERVAL 30 MINUTE ), '%Y-%m-%d %H:%i:%s') ]]> limit 1

    </select>

    <select id="queryAllOrderStatusByJourneyId" parameterType="java.lang.Long" resultType="string">
    select state  from order_info where journey_id=#{journeyId}
    </select>

    <select id="queryVaildOrderStatusByPowerId" parameterType="java.lang.Long" resultType="string">
     select state from order_info where power_id=#{powerId} order by create_time desc  limit 1
    </select>

    <select id="queryVaildOrderIdByPowerId" parameterType="java.lang.Long" resultType="java.lang.Long">
     select order_id from order_info where power_id=#{powerId} and state !='S900' order by create_time desc  limit 1
    </select>

    <select id="queryAllOrderStatusByPowerId" parameterType="java.lang.Long" resultType="string">
     select state from order_info where power_id=#{powerId}
    </select>

    <select id="queryOrderIdListByPowerId" parameterType="java.lang.Long" resultType="java.lang.Long">
    select order_id from order_info where power_id=#{powerId} and state not in ('S900')
    </select>

    <select id="queryUseCarMode" parameterType="java.lang.Long" resultType="string">
    select use_car_mode from order_info where power_id=#{powerId} order by create_time desc
    </select>

    <select id="getValidOrderByPowerId" resultType="com.hq.ecmp.mscore.domain.OrderInfo" parameterType="java.lang.Long">
        <include refid="selectOrderInfoVo"/>
        where power_id=#{powerId}
        AND STATE !='S900'
    </select>


    <select id="getSetOutClashTask" parameterType="com.hq.ecmp.mscore.bo.OrderTaskClashBo" resultType="com.hq.ecmp.mscore.domain.OrderInfo">
        SELECT
           ord.*
        FROM  order_info ord
        LEFT JOIN journey_plan_price_info jpp on jpp.node_id=ord.node_id and jpp.journey_id=ord.journey_id
        <where>
            <if test="carId != null and  carId!=''"> and  ord.car_id=#{carId}  </if>
            <if test="setOutTime != null "> and jpp.planned_arrival_time > #{setOutTime}  </if>
            <if test="driverId != null and  driverId!='' "> and ord.driver_id = #{driverId}  </if>
        </where>
        ORDER BY  ord.order_id DESC
    </select>

    <select id="getArrivalClashTask" parameterType="com.hq.ecmp.mscore.bo.OrderTaskClashBo" resultType="com.hq.ecmp.mscore.domain.OrderInfo">
        SELECT
            ord.*
        FROM  order_info ord
        LEFT JOIN journey_plan_price_info jpp on jpp.node_id=ord.node_id and jpp.journey_id=ord.journey_id
        <where>
            <if test="carId != null and  carId!=''"> and  ord.car_id = #{carId} </if>
            <if test="arrivalTime != null "> and #{arrivalTime} > jpp.planned_departure_time</if>
            <if test="driverId != null and  driverId!='' "> and ord.driver_id = #{driverId}</if>
        </where>
        ORDER BY  ord.order_id DESC
    </select>

    <!-- 查询不冲突的 前任务 借用create_time-->
    <select id="getSetOutBeforeTaskForCarOrDriver" parameterType="com.hq.ecmp.mscore.bo.OrderTaskClashBo" resultMap="OrderInfoResult">
        SELECT
            ord.order_id,
            jpp.planned_departure_time as create_time
        FROM  order_info ord
        LEFT JOIN journey_plan_price_info jpp on jpp.node_id=ord.node_id and jpp.journey_id=ord.journey_id
        <where>
            <if test="carId != null and  carId!=''"> and  ord.car_id=#{carId}  </if>
            <if test="setOutTime != null "> and jpp.planned_arrival_time >#{setOutTime}  </if>
            <if test="driverId != null and  driverId!='' "> and ord.driver_id = #{driverId}</if>
        </where>
        ORDER BY  ord.order_id DESC
    </select>

    <!-- 查询不冲突的 后任务,借用update_time传递值-->
    <select id="getArrivalAfterTaskForCarOrDriver" parameterType="com.hq.ecmp.mscore.bo.OrderTaskClashBo" resultMap="OrderInfoResult">
        SELECT
            ord.order_id,
            jpp.planned_arrival_time as update_time
        FROM  order_info ord
        LEFT JOIN journey_plan_price_info jpp on jpp.node_id=ord.node_id and jpp.journey_id=ord.journey_id
        <where>
            <if test="carId != null and  carId!=''"> and  ord.car_id=#{carId} </if>
            <if test="arrivalTime != null "> and #{arrivalTime} > jpp.planned_departure_time </if>
            <if test="driverId != null and  driverId!='' "> and ord.driver_id = #{driverId} </if>
        </where>
        ORDER BY  ord.order_id DESC
    </select>

    <select id="getExpiredOrder" resultMap="OrderInfoResult">
        select oi.* from  order_info oi
        left join order_address_info oai on oi.order_id=oai.order_id and oai.type='A000'
        where oai.action_time &lt; now()
        and oi.state in('S000','S100','S101');
    </select>

    <select id="queryLatestOrderByPowerId" parameterType="java.lang.Long" resultType="string">
       select
      (select os.state from order_state_trace_info os where os.order_id=s.order_id order by os.trace_id desc limit 1)	state
      from order_info s
      where s.power_id=#{powerId} order by s.order_id desc limit 0,1
    </select>

    <select id="selectOrderStateById" parameterType="java.lang.Long" resultType="com.hq.ecmp.mscore.domain.OrderInfo">

         select order_id orderId,state,use_car_mode useCarMode,
         (select state from order_state_trace_info sti where sti.order_id=#{orderId} order by trace_id desc limit 1) labelState
         from  order_info where order_id = #{orderId}
    </select>

    <select id="getCountForDispatched" parameterType="Object" resultType="java.lang.Long">
         SELECT count(*) FROM order_info where state='S100'
          and user_id in
        <foreach item="userId" collection="users" open="(" separator="," close=")">
            #{userId}
        </foreach>
    </select>
    <select id="getCountForReassigned" parameterType="Object" resultType="java.lang.Long">
         SELECT count(*) FROM order_info
         where  user_id in
            <foreach item="userId" collection="users" open="(" separator="," close=")">
            #{userId}
            </foreach>
        AND order_id IN  (SELECT order_id from
        ( SELECT order_id ,state FROM ( SELECT order_id, state FROM order_state_trace_info ORDER BY trace_id DESC) r GROUP BY r.order_id having r.state = 'S279' )
         tmp)
    </select>

    <select id="getRunningOrder" resultType="com.hq.ecmp.mscore.vo.RunningOrderVo">
        select
            a.order_id AS orderId,
            a.journey_id journeyId,
            a.power_id powerId,
            '进行中' state,
            a.service_type serviceType,
            a.user_id userId,
            a.driver_id driverId,
            a.use_car_mode canUseCarMode,
            e.address startAddress,
            DATE_FORMAT(e.action_time, '%m月%d日 %H:%i ') useCarTime,
            e.longitude startLongitude,
            e.latitude startLatitude,
            UNIX_TIMESTAMP(e.action_time)*1000 useDate,
            d.address endAddress,
            d.longitude endLongitude ,
            d.latitude endLatitude,
            g.charter_car_type charterCarType,
            (select state from order_state_trace_info sti where sti.order_id=a.order_id order by sti.trace_id desc limit 1) labelState,
            ai.apply_type applyType
        from order_info a
	        left join journey_info g on g.journey_id=a.journey_id
	        left join apply_info ai on ai.journey_id=a.journey_id
            left join order_address_info e on (e.order_id=a.order_id and e.type='A000')
            left join order_address_info d on (d.order_id=a.order_id and d.type='A999')
        where a.user_id=#{userId}  and find_in_set(a.state,#{states})
    </select>
    <select id="getAlreadyUsingOrderIdByPowerId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select o.order_id from  journey_user_car_power jucp
        left join order_info o on o.power_id=jucp.power_id
        left join order_state_trace_info osti on osti.order_id=o.order_id
        where o.state='S900'
        and osti.state in('S900','S901')
        and jucp.power_id=#{powerId}

  </select>
    <select id="selectOrderEnd" resultMap="OrderInfoResult">
        SELECT * FROM `order_info` where state='S900' and FIND_IN_SET('S900',(select GROUP_CONCAT(state) states from order_state_trace_info where order_id=order_info.order_id))
    </select>

    <select id="getSceneByOrder" resultType="long">
        select scene_id from scene_regime_relation where regimen_id=(
            SELECT regimen_id FROM `journey_info` where journey_id=#{journeyId}
        )
    </select>
    <select id="getProvinceByOrder" resultType="string">
        select PROVINCE_NAME from china_province where PROVINCE_CODE=CONCAT(SUBSTR((SELECT city_postal_code FROM order_address_info where order_id=#{orderId} and type='A000') FROM 1 FOR 2),'0000')
    </select>
    <select id="getOrderDurationById" resultType="double">
        select ROUND((TIMESTAMPDIFF(MINUTE,MIN(create_time),MAX(create_time))/60),2)duration FROM order_state_trace_info where order_id=#{orderId}
    </select>
    <select id="getOrderStateTraceById" resultType="string">
        select GROUP_CONCAT(order_state_trace_info.state) from order_state_trace_info where order_id=#{orderId}
    </select>
    <select id="getdispatchDurationById" resultType="int">
        select ifnull(TIMESTAMPDIFF(MINUTE,(select create_time from order_state_trace_info where order_id=#{orderId} and state='S100'),
        (select create_time from order_state_trace_info where order_id=#{orderId} and state='S299')),0)
    </select>
    <select id="selectOrderInfoByIdAllDay" parameterType="java.lang.Long" resultMap="OrderInfoResult">
        <include refid="selectOrderInfoVo"/>
        where user_id = #{userId} and to_days(create_time) = to_days(now());
    </select>
    <select id="getCarMessage" resultType="com.hq.ecmp.mscore.domain.OrderInfoMessage" parameterType="java.lang.Long">
            select order_id orderId,car_model carModel,car_license carLicense,driver_name driverName,car_color carColor
             from  order_info where order_id = #{orderId}
    </select>

    <select id="queryDispatchList" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery" resultType="com.hq.ecmp.mscore.vo.DispatchVo">

        SELECT DISTINCT
                -- 订单id
                oi.order_id orderId,
                -- 部门名称
                eo.dept_name AS deptName,
                -- 公司名称
                eor.dept_name AS companyName,
                -- 操作权限  0：有权限  1:没有权限
                  '0'  operationPermission,
                -- 申请人姓名
                eu.nick_name  applyUserName,
                -- 申请人手机号
                eu.phonenumber applyUserTel,
                -- 乘车人
                eu.nick_name  useCarUserName,
                -- 同行人数量
                jpi.peer_number travelPartnerCount,
                -- 开始时间
                oai.action_time useCarDate,
                -- 预计结束时间
                oaitwo.action_time endDate,
                -- 上车地址
                oai.address startSite,
                -- 下车地址
                oaitwo.address endSite,
                -- 是否往返
                ji.it_is_return itIsReturn,
                -- 预计等待时长
                ji.wait_time_long waitMinute,
                -- 用车城市
                cc.SHORT_NAME useCarCity,
                -- 用车场景
                si.`name` userCarScene,
                -- 用车制度
                ri.`name` userCarRegime,
                round((UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(oi.create_time))/60)   waitingTime,
                -- 服务类型
                oi.service_type serverType,
                -- 状态
                case
                    when right (z.state,3)='100' then '待派车'
                    when right (z.state,3)<![CDATA[ >= ]]>'299' and right (z.state,3)<![CDATA[ <= ]]>'900'   then '已处理'
                    when right (z.state,3)='921' then '已过期'
                    when right (z.state,3)='930' then '已驳回'
                    when right (z.state,3)='911' then '已取消'
                    ELSE '' END state,
                -- 操作时间
            case
                when right (oi.state,3)='100' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S100'  limit 1)
                when right (oi.state,3)='299' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state ='S299' limit 1)
                when right (oi.state,3)= '900' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state in ('S921','S930') limit 1)
            ELSE now() END opDate
                FROM
                order_info oi
                LEFT JOIN car_group_info cgi ON oi.company_id = cgi.company_id
                LEFT JOIN ecmp_user eu ON oi.user_id = eu.user_id
                LEFT JOIN ecmp_org eo ON eu.dept_id = eo.dept_id
                LEFT JOIN ecmp_org eor ON eo.company_id= eor.dept_id
                LEFT JOIN journey_info ji ON ji.journey_id = oi.journey_id
                LEFT JOIN journey_passenger_info jpi ON jpi.journey_id = oi.journey_id
                LEFT JOIN regime_info ri ON ri.regimen_id = ji.regimen_id
                LEFT JOIN scene_regime_relation srr ON srr.regimen_id = ri.regimen_id
                LEFT JOIN scene_info si ON srr.scene_id = si.scene_id
                LEFT JOIN order_address_info oai ON (oai.order_id = oi.order_id and oai.type='A000')
                LEFT JOIN order_address_info oaitwo ON (oaitwo.order_id = oi.order_id and oaitwo.type='A999')
                LEFT JOIN china_city cc ON cc.CITY_CODE = oai.city_postal_code
                LEFT JOIN (select order_id,state from order_state_trace_info where trace_id in (select Max(trace_id) traceId from order_state_trace_info  group by order_id))  z on z.order_id=oi.order_id
        WHERE 1 = 1
                and oi.order_id in (select distinct order_id from order_state_trace_info where order_id in
                (select distinct order_id from order_state_trace_info where state in ('S299', 'S921', 'S100'))
                and order_id not in (select distinct order_id from order_state_trace_info where state in ('S270', 'S279', 'S277'))  )
                <if test="companyId!=null">
                      and  oi.company_id=#{companyId}
                </if>
                <if test="applyName!=null">
                    and  eu.nick_name=#{applyName}
                </if>
                <if test="applyMobile!=null">
                    and  eu.phonenumber=#{applyMobile}
                </if>
                <if test="cityCode!=null">
                    and  cc.SHORT_NAME=#{cityCode}
                </if>
                <if test="useCarMode!=null">
                    and  oi.use_car_mode=#{useCarMode}
                </if>
                <if test="dispatchStatus!=null">
                    and  oi.state=#{dispatchStatus}
                </if>
                <if test="optStartDate!=null  and  optStartDate!='' ">
                    and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{optStartDate},'%Y-%m-%d %H:%i:%S')
                </if>
                <if test="optEndDate!=null  and  optEndDate!='' ">
                    and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{optEndDate},'%Y-%m-%d %H:%i:%S')
                </if>
                and  oi.it_is_supplement='N000'
                and oi.user_id in (select distinct user_id from ecmp_user where dept_id in
                (select dept_id from car_group_serve_org_relation where car_group_id in
                (select car_group_id from car_group_dispatcher_info where user_id=#{userId})))
                ORDER BY
                oi.state,oai.action_time ASC
    </select>

    <select id="queryAdminDispatchList" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery" resultType="com.hq.ecmp.mscore.vo.DispatchVo">

        SELECT DISTINCT
        -- 订单id
        oi.order_id orderId,
        -- 部门名称
        eo.dept_name AS deptName,
        -- 公司名称
        eor.dept_name AS companyName,
        -- 操作权限  0：有权限  1:没有权限
        '1'  operationPermission,
        -- 申请人姓名
        eu.nick_name  applyUserName,
        -- 申请人手机号
        eu.phonenumber applyUserTel,
        -- 乘车人
        eu.nick_name  useCarUserName,
        -- 同行人数量
        jpi.peer_number travelPartnerCount,
        -- 开始时间
        oai.action_time useCarDate,
        -- 预计结束时间
        oaitwo.action_time endDate,
        -- 上车地址
        oai.address startSite,
        -- 下车地址
        oaitwo.address endSite,
        -- 是否往返
        ji.it_is_return itIsReturn,
        -- 预计等待时长
        ji.wait_time_long waitMinute,
        round((UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(oi.create_time))/60)   waitingTime,
        -- 用车城市
        cc.SHORT_NAME useCarCity,
        -- 用车场景
        si.`name` userCarScene,
        -- 用车制度
        ri.`name` userCarRegime,
        -- 服务类型
        oi.service_type serverType,
        -- 状态
        case
        when right (z.state,3)='100' then '待派车'
        when right (z.state,3)<![CDATA[ >= ]]>'299' and right (z.state,3)<![CDATA[ <= ]]>'900'   then '已处理'
        when right (z.state,3)='921' then '已过期'
        when right (z.state,3)='930' then '已驳回'
        when right (z.state,3)='911' then '已取消'
        ELSE '' END state,
        -- 操作时间
        case
        when right (oi.state,3)='100' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S100'  limit 1)
        when right (oi.state,3)='299' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state ='S299' limit 1)
        when right (oi.state,3)= '900' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state in ('S921','S930') limit 1)
        ELSE now() END opDate
        FROM
        order_info oi
        LEFT JOIN car_group_info cgi ON oi.company_id = cgi.company_id
        LEFT JOIN ecmp_user eu ON oi.user_id = eu.user_id
        LEFT JOIN ecmp_org eo ON eu.dept_id = eo.dept_id
        LEFT JOIN ecmp_org eor ON eo.company_id= eor.dept_id
        LEFT JOIN journey_info ji ON ji.journey_id = oi.journey_id
        LEFT JOIN journey_passenger_info jpi ON jpi.journey_id = oi.journey_id
        LEFT JOIN regime_info ri ON ri.regimen_id = ji.regimen_id
        LEFT JOIN scene_regime_relation srr ON srr.regimen_id = ri.regimen_id
        LEFT JOIN scene_info si ON srr.scene_id = si.scene_id
        LEFT JOIN order_address_info oai ON (oai.order_id = oi.order_id and oai.type='A000')
        LEFT JOIN order_address_info oaitwo ON (oaitwo.order_id = oi.order_id and oaitwo.type='A999')
        LEFT JOIN china_city cc ON cc.CITY_CODE = oai.city_postal_code
        LEFT JOIN (select order_id,state from order_state_trace_info where trace_id in (select Max(trace_id) traceId from order_state_trace_info  group by order_id))  z on z.order_id=oi.order_id
        WHERE 1 = 1
        and oi.order_id in (select distinct order_id from order_state_trace_info where order_id in
        (select distinct order_id from order_state_trace_info where state in ('S299', 'S921', 'S100'))
        and order_id not in (select distinct order_id from order_state_trace_info where state in ('S270', 'S279', 'S277'))  )
        <if test="companyId!=null">
            and  oi.company_id=#{companyId}
        </if>
        <if test="applyName!=null and applyName!=''">
            and  eu.nick_name=#{applyName}
        </if>
        <if test="applyMobile!=null and applyMobile!=''">
            and  eu.phonenumber=#{applyMobile}
        </if>
        <if test="cityCode!=null and cityCode!= ''">
            and  cc.SHORT_NAME=#{cityCode}
        </if>
        <if test="useCarMode!=null and useCarMode!=''">
            and  oi.use_car_mode=#{useCarMode}
        </if>
        <if test="dispatchStatus!=null and dispatchStatus!=''">
            and  oi.state=#{dispatchStatus}
        </if>
        <if test="optStartDate!=null  and  optStartDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{optStartDate},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="optEndDate!=null  and  optEndDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{optEndDate},'%Y-%m-%d %H:%i:%S')
        </if>
        and  oi.it_is_supplement='N000'
        <if test="orderIds!=null">
            and oi.order_id not in
            <foreach collection="orderIds" open="(" separator="," close=")" item="orderId">
                #{orderId}
            </foreach>
        </if>

        ORDER BY
        oi.state,oai.action_time ASC
    </select>
    <select id="queryDispatchOrder" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery" resultType="com.hq.ecmp.mscore.vo.DispatchVo">
        SELECT DISTINCT
        -- 订单id
        oi.order_id orderId,
        -- 部门名称
        eo.dept_name AS deptName,
        -- 公司名称
        eor.dept_name AS companyName,
        -- 申请人姓名
        eu.nick_name  applyUserName,
        -- 申请人手机号
        eu.phonenumber applyUserTel,
        -- 乘车人
        eu.nick_name  useCarUserName,
        -- 同行人数量
        jpi.peer_number travelPartnerCount,
        -- 开始时间
        oai.action_time useCarDate,
        round((UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(oi.create_time))/60)   waitingTime,
        -- 预计结束时间
        oaitwo.action_time endDate,
        -- 上车地址
        oai.address startSite,
        -- 下车地址
        oaitwo.address endSite,
        -- 是否往返
        ji.it_is_return itIsReturn,
        -- 预计等待时长
        ji.wait_time_long waitMinute,
        -- 用车城市
        cc.SHORT_NAME useCarCity,
        -- 用车场景
        si.`name` userCarScene,
        -- 用车制度
        ri.`name` userCarRegime,
        -- 服务类型
        oi.service_type serverType,
        -- 状态
        oi.state state,
        -- 操作时间
        oi.update_time opDate,
        -- 申请原因
        ai.reason reason,
        -- 成本中心
        eor.dept_name costCenter,
        -- 项目编号
        pi.name projectName
        FROM
        order_info oi
        LEFT JOIN car_group_info cgi ON oi.company_id = cgi.company_id
        LEFT JOIN ecmp_user eu ON oi.user_id = eu.user_id
        LEFT JOIN ecmp_org eo ON eu.dept_id = eo.dept_id
        LEFT JOIN ecmp_org eor ON eo.company_id= eor.dept_id
        LEFT JOIN journey_info ji ON ji.journey_id = oi.journey_id
        LEFT JOIN apply_info ai on ai.journey_id=oi.journey_id
        LEFT JOIN ecmp_org eori on ai.cost_center=eori.dept_id
        LEFT JOIN journey_passenger_info jpi ON jpi.journey_id = oi.journey_id
        LEFT JOIN regime_info ri ON ri.regimen_id = ji.regimen_id
        LEFT JOIN scene_regime_relation srr ON srr.regimen_id = ri.regimen_id
        LEFT JOIN scene_info si ON srr.scene_id = si.scene_id
        LEFT JOIN order_address_info oai ON oai.order_id = oi.order_id and oai.type='A000'
        LEFT JOIN order_address_info oaitwo ON oaitwo.order_id = oi.order_id and oaitwo.type='A999'
        LEFT JOIN china_city cc ON cc.CITY_CODE = oai.city_postal_code
        LEFT JOIN project_info pi ON pi.project_id = ai.project_id
        LEFT JOIN order_state_trace_info osti on oi.order_id = osti.order_id
        WHERE 1 = 1
        <if test="companyId != null and  companyId!=''"> and  oi.company_id=#{companyId} </if>
        <if test="userId != null and  userId!=''"> and  osti.create_by=#{userId} </if>
        <if test="applyName!=null">
            and  eu.nick_name=#{applyName}
        </if>
        <if test="applyMobile!=null">
            and  eu.phonenumber=#{applyMobile}
        </if>
        <if test="cityCode!=null">
            and  cc.SHORT_NAME=#{cityCode}
        </if>
        <if test="useCarMode!=null">
            and  oi.use_car_mode=#{useCarMode}
        </if>
        <if test="dispatchStatus!=null">
            and  oi.state=#{dispatchStatus}
        </if>
        <if test="optStartDate!=null  and  optStartDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{optStartDate},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="optEndDate!=null  and  optEndDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{optEndDate},'%Y-%m-%d %H:%i:%S')
        </if>
        and oi.it_is_supplement = 'D000'
        ORDER BY
        oi.state,oai.action_time ASC
    </select>


    <select id="queryDispatchReassignmentList" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery" resultType="com.hq.ecmp.mscore.vo.DispatchVo">

        SELECT DISTINCT
        -- 订单id
        oi.order_id orderId,
        -- 部门名称
        eo.dept_name AS deptName,
        -- 公司名称
        eor.dept_name AS companyName,
        -- 操作权限  0：有权限  1:没有权限
        '0'  operationPermission,
        -- 申请人姓名
        eu.nick_name  applyUserName,
        -- 申请人手机号
        eu.phonenumber applyUserTel,
        -- 乘车人
        eu.nick_name  useCarUserName,
        -- 同行人数量
        jpi.peer_number travelPartnerCount,
        -- 开始时间
        oai.action_time useCarDate,
        round((UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(oi.create_time))/60)   waitingTime,
        -- 预计结束时间
        oaitwo.action_time endDate,
        -- 上车地址
        oai.address startSite,
        -- 下车地址
        oaitwo.address endSite,
        -- 是否往返
        ji.it_is_return itIsReturn,
        -- 预计等待时长
        ji.wait_time_long waitMinute,
        -- 用车城市
        cc.SHORT_NAME useCarCity,
        -- 用车场景
        si.`name` userCarScene,
        -- 用车制度
        ri.`name` userCarRegime,
        -- 服务类型
        oi.service_type serverType,
        -- 状态
        case
        when right (z.state,3)='270' then '待改派'
        when right (z.state,3)='279' then '已通过'
        when right (z.state,3)='277' then '以驳回'
        when right (z.state,3)='921' then '已过期'
        ELSE '' END state,
        -- 操作时间
        case
        when right (z.state,3)='270' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S270'  limit 1)
        when right (z.state,3) IN ('279','277') then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state in ('S277','S279') limit 1)
        when right (z.state,3)= '921' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S921' limit 1)
        ELSE now() END opDate
        FROM
        order_info oi
        LEFT JOIN ecmp_user eu ON oi.user_id = eu.user_id
        LEFT JOIN (select order_id,state from order_state_trace_info where trace_id in (select Max(trace_id) traceId from order_state_trace_info  group by order_id))  z on z.order_id=oi.order_id
        LEFT JOIN ecmp_org eo ON eu.dept_id = eo.dept_id
        LEFT JOIN ecmp_org eor ON eo.company_id= eor.dept_id
        LEFT JOIN journey_info ji ON ji.journey_id = oi.journey_id
        LEFT JOIN journey_passenger_info jpi ON jpi.journey_id = oi.journey_id
        LEFT JOIN regime_info ri ON ri.regimen_id = ji.regimen_id
        LEFT JOIN scene_regime_relation srr ON srr.regimen_id = ri.regimen_id
        LEFT JOIN scene_info si ON srr.scene_id = si.scene_id
        LEFT JOIN order_address_info oai ON (oai.order_id = oi.order_id and oai.type='A000')
        LEFT JOIN order_address_info oaitwo ON (oaitwo.order_id = oi.order_id and oaitwo.type='A999')
        LEFT JOIN china_city cc ON cc.CITY_CODE = oai.city_postal_code
        WHERE 1 = 1
        and oi.order_id in (select distinct order_id from order_state_trace_info where state in ('S279', 'S277') and create_by=#{userId}
        union (SELECT distinct order_id from order_state_trace_info where order_id in (select distinct order_id from order_state_trace_info where state='S299' and create_by=#{userId}) and state='S270')
        union (SELECT distinct order_id from order_state_trace_info where state='S921')  )
        <if test="companyId!=null">
            and  oi.company_id=#{companyId}
        </if>
        <if test="applyName!=null">
            and  eu.nick_name=#{applyName}
        </if>
        <if test="applyMobile!=null">
            and  eu.phonenumber=#{applyMobile}
        </if>
        <if test="cityCode!=null">
            and  cc.SHORT_NAME=#{cityCode}
        </if>
        <if test="useCarMode!=null">
            and  oi.use_car_mode=#{useCarMode}
        </if>
        <if test="dispatchStatus!=null">
            and  oi.state=#{dispatchStatus}
        </if>
        <if test="optStartDate!=null  and  optStartDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{optStartDate},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="optEndDate!=null  and  optEndDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{optEndDate},'%Y-%m-%d %H:%i:%S')
        </if>
        and  oi.it_is_supplement='N000'
        ORDER BY
        oi.state,oai.action_time ASC
    </select>

    <select id="queryAdminDispatchReassignmentList" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery" resultType="com.hq.ecmp.mscore.vo.DispatchVo">

        SELECT DISTINCT
        -- 订单id
        oi.order_id orderId,
        -- 部门名称
        eo.dept_name AS deptName,
        -- 公司名称
        eor.dept_name AS companyName,
        -- 操作权限  0：有权限  1:没有权限
        '1'  operationPermission,
        -- 申请人姓名
        eu.nick_name  applyUserName,
        -- 申请人手机号
        eu.phonenumber applyUserTel,
        -- 乘车人
        eu.nick_name  useCarUserName,
        -- 同行人数量
        jpi.peer_number travelPartnerCount,
        -- 开始时间
        oai.action_time useCarDate,
        round((UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(oi.create_time))/60)   waitingTime,
        -- 预计结束时间
        oaitwo.action_time endDate,
        -- 上车地址
        oai.address startSite,
        -- 下车地址
        oaitwo.address endSite,
        -- 是否往返
        ji.it_is_return itIsReturn,
        -- 预计等待时长
        ji.wait_time_long waitMinute,
        -- 用车城市
        cc.SHORT_NAME useCarCity,
        -- 用车场景
        si.`name` userCarScene,
        -- 用车制度
        ri.`name` userCarRegime,
        -- 服务类型
        oi.service_type serverType,
        -- 状态
        case
        when right (z.state,3)='270' then '待改派'
        when right (z.state,3)='279' then '已通过'
        when right (z.state,3)='277' then '以驳回'
        when right (z.state,3)='921' then '已过期'
        ELSE '' END state,
        -- 操作时间
        case
        when right (z.state,3)='100' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S270'  limit 1)
        when right (z.state,3) IN ('279','277') then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state in ('S277','S279') limit 1)
        when right (z.state,3)= '921' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S921' limit 1)
        ELSE now() END opDate
        FROM
        order_info oi
        LEFT JOIN ecmp_user eu ON oi.user_id = eu.user_id
        LEFT JOIN (select order_id,state from order_state_trace_info where trace_id in (select Max(trace_id) traceId from order_state_trace_info  group by order_id))  z on z.order_id=oi.order_id
        LEFT JOIN ecmp_org eo ON eu.dept_id = eo.dept_id
        LEFT JOIN ecmp_org eor ON eo.company_id= eor.dept_id
        LEFT JOIN journey_info ji ON ji.journey_id = oi.journey_id
        LEFT JOIN journey_passenger_info jpi ON jpi.journey_id = oi.journey_id
        LEFT JOIN regime_info ri ON ri.regimen_id = ji.regimen_id
        LEFT JOIN scene_regime_relation srr ON srr.regimen_id = ri.regimen_id
        LEFT JOIN scene_info si ON srr.scene_id = si.scene_id
        LEFT JOIN order_address_info oai ON (oai.order_id = oi.order_id and oai.type='A000')
        LEFT JOIN order_address_info oaitwo ON (oaitwo.order_id = oi.order_id and oaitwo.type='A999')
        LEFT JOIN china_city cc ON cc.CITY_CODE = oai.city_postal_code
        WHERE 1 = 1
        and oi.order_id in (select distinct order_id from order_state_trace_info where state in ('S270', 'S279', 'S277','S921'))
        <if test="companyId!=null">
            and  oi.company_id=#{companyId}
        </if>
        <if test="applyName!=null">
            and  eu.nick_name=#{applyName}
        </if>
        <if test="applyMobile!=null">
            and  eu.phonenumber=#{applyMobile}
        </if>
        <if test="cityCode!=null">
            and  cc.SHORT_NAME=#{cityCode}
        </if>
        <if test="useCarMode!=null">
            and  oi.use_car_mode=#{useCarMode}
        </if>
        <if test="dispatchStatus!=null">
            and  oi.state=#{dispatchStatus}
        </if>
        <if test="optStartDate!=null  and  optStartDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{optStartDate},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="optEndDate!=null  and  optEndDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{optEndDate},'%Y-%m-%d %H:%i:%S')
        </if>
        and  oi.it_is_supplement='N000'
        <if test="orderIds!=null">
            and oi.order_id not in
            <foreach collection="orderIds" open="(" separator="," close=")" item="orderId">
                #{orderId}
            </foreach>
        </if>

        ORDER BY
        oi.state,oai.action_time ASC
    </select>

    <select id="getReplentshmentOrder" parameterType="com.hq.ecmp.mscore.dto.OrderListBackDto" resultType="com.hq.ecmp.mscore.dto.OrderListBackDto">
          SELECT DISTINCT
        -- 订单id
        oi.order_id orderId,
        -- 部门名称
        eo.dept_name AS deptName,
        -- 公司名称
        eor.dept_name AS companyName,
        -- 申请人姓名
        eu.nick_name  applyName,
        -- 申请人手机号
        eu.phonenumber applyPhoneNumber,
        -- 乘车人
        eu.nick_name  passengerName,
        -- 开始时间
        oai.action_time beginTime,
        -- 同行人数量
        oi.tripartite_platform_code peerName,
        -- 预计结束时间
        oaitwo.action_time endTime,
        -- 上车地址
        oai.address beginAddress,

        oi.use_car_mode useCarMode,
        -- 下车地址
        oaitwo.address endAddress,
        -- 用车城市
        -- cc.SHORT_NAME useCarCity,
        -- 用车场景
        -- si.`name` userCarScene,
        -- 用车制度
        -- ri.`name` regimenName,
        -- 服务类型
        oi.service_type serviceType,
        -- 状态
        oi.state orderState,
        oi.it_is_supplement itIsSupplement,
        oi.order_number orderNumber,
				CONVERT(osi.amount,DECIMAL(10,2))  amount
        FROM
        order_info oi
				LEFT JOIN regime_info ri ON ri.regimen_id = oi.driver_grade
        LEFT JOIN scene_regime_relation srr ON srr.regimen_id = ri.regimen_id
        LEFT JOIN scene_info si ON srr.scene_id = si.scene_id
        LEFT JOIN ecmp_user eu ON oi.user_id = eu.user_id
        LEFT JOIN ecmp_org eo ON eu.dept_id = eo.dept_id
        LEFT JOIN ecmp_org eor ON eo.company_id= eor.dept_id
        LEFT JOIN order_address_info oai ON oai.order_id = oi.order_id and oai.type='A000'
        LEFT JOIN order_address_info oaitwo ON oaitwo.order_id = oi.order_id and oaitwo.type='A999'
        LEFT JOIN china_city cc ON cc.CITY_CODE = oai.city_postal_code
				LEFT join order_settling_info osi on osi.order_id=oi.order_id
        WHERE 1 = 1
        and  oi.company_id=#{companyId}
         and oi.order_id=#{orderId}
        ORDER BY
        oi.order_id DESC
    </select>

    <select id="getOrderById" parameterType="java.lang.String" resultType="java.lang.String">
          SELECT it_is_Supplement itIsSupplement  FROM  order_info WHERE  order_id=#{orderNo}
    </select>

    <select id="getOrderListDetailById" parameterType="java.lang.String" resultType="com.hq.ecmp.mscore.dto.OrderDetailBackDto">
        SELECT DISTINCT
        -- 订单id
        oi.order_id orderId,
        -- 部门名称
        eo.dept_name AS deptName,
        -- 公司名称
        eor.dept_name AS companyName,
        -- 申请人姓名
        eu.nick_name  applyName,
        -- 申请人手机号
        eu.phonenumber applyPhoneNumber,
        -- 乘车人
        eu.nick_name  passengerName,
        -- 申请人手机号
        eu.phonenumber passengerMobile,
        -- 开始时间
        oai.action_time useCarTime,
        -- 预计结束时间
        oaitwo.action_time planningArriveTime,
        -- 开始时间
        oai.action_time beginTime,
        -- 预计结束时间
        oaitwo.action_time endTime,
        -- 上车地址
        oai.address planningSetOutAddress,
        -- 下车地址
        oaitwo.address planningArriveAddress,
        oi.use_car_mode useCarMode,
        -- 用车城市
        -- cc.SHORT_NAME useCarCity,
        -- 用车场景
         si.`name` userCarScene,
        -- 用车制度
         ri.`name` regimenName,
        -- 服务类型
        oi.service_type serviceType,
        -- 状态
        oi.state orderState,
        oi.it_is_supplement itIsSupplement,
        oi.order_number orderNumber,
        CONVERT(osi.amount,DECIMAL(10,2))  amount,
        ci.car_type carType,
        ci.car_color carColor,
        ci.car_license  carlicense,
        di.driver_name driverName,
        di.mobile   driverPhone,
        ecty.`name` carLevel,
        osi.total_time totalTime,
        ji.charter_car_type charterCarType,
        (select notes   from apply_info where journey_id=ji.journey_id)notes,
        (select reason  from apply_info where journey_id=ji.journey_id)reason,
        (select car_group_name  from car_group_info where car_group_id= ci.car_group_id)carGroupName,
        (select car_group_name  from car_group_info where car_group_id in
              (select car_group_id from car_group_driver_relation where driver_id=s.driver_id)
        )driverGroupName,
        CONVERT(osi.total_mileage,DECIMAL(10,2))  totalMileage,
        osi.amount_detail amountDetail
        FROM
        order_info oi
				LEFT JOIN regime_info ri ON ri.regimen_id = oi.driver_grade
        LEFT JOIN scene_regime_relation srr ON srr.regimen_id = ri.regimen_id
        LEFT JOIN scene_info si ON srr.scene_id = si.scene_id
        LEFT JOIN ecmp_user eu ON oi.user_id = eu.user_id
        LEFT JOIN ecmp_org eo ON eu.dept_id = eo.dept_id
        LEFT JOIN ecmp_org eor ON eo.company_id= eor.dept_id
        LEFT JOIN order_address_info oai ON oai.order_id = oi.order_id and oai.type='A000'
        LEFT JOIN order_address_info oaitwo ON oaitwo.order_id = oi.order_id and oaitwo.type='A999'
        LEFT JOIN china_city cc ON cc.CITY_CODE = oai.city_postal_code
				LEFT join order_settling_info osi on osi.order_id=oi.order_id
				LEFT JOIN car_info ci ON ci.car_id = oi.car_id
				LEFT JOIN enterprise_car_type_info ecty on ecty.car_type_id = ci.car_type_id
				LEFT JOIN driver_info di ON di.driver_id = oi.driver_id
				LEFT JOIN journey_info ji ON ji.journey_id = oi.journey_id
        WHERE 1 = 1
         and oi.order_id=#{orderNo}
        ORDER BY
        oi.order_id DESC
    </select>
    <select id="selectUsingCarByCarId" resultMap="OrderInfoResult" parameterType="long">
        select * from order_info where car_id = #{carId} and state not in ('S699','S900')
    </select>

    <select id="getUserTimeAndActionTime" resultType="com.hq.ecmp.mscore.domain.OrderInfoDate" parameterType="long">
        SELECT
        s.action_time useCarTime,
        jn.use_time useTime
        FROM
        order_info o
        LEFT JOIN journey_info jn ON o.journey_id = jn.journey_id
        LEFT JOIN order_address_info s ON s.order_id = o.order_id
        AND s.type = 'A000'

        WHERE
        o.order_id = #{orderNo}
    </select>

    <select id="queryDispatchListCharterCar" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery" resultType="com.hq.ecmp.mscore.vo.DispatchVo">

        SELECT DISTINCT
        -- 订单id
        oi.order_id orderId,
        -- 部门名称
        eo.dept_name AS deptName,
        -- 公司名称
        eor.dept_name AS companyName,
        -- 操作权限  0：有权限  1:没有权限
        '0'  operationPermission,
        -- 申请人姓名
        eu.nick_name  applyUserName,
        -- 申请人手机号
        eu.phonenumber applyUserTel,
        -- 乘车人
        jpi.name  useCarUserName,
        -- 乘车人电话
        jpi.mobile userCarUserMobile,
        -- 同行人数量
        jpi.peer_number travelPartnerCount,
        -- 开始时间
        oai.action_time useCarDate,
        -- 预计结束时间
        oaitwo.action_time endDate,
        -- 上车地址
        oai.address startSite,
        -- 下车地址
        oaitwo.address endSite,
        -- 是否往返
        ji.it_is_return itIsReturn,
        -- 预计等待时长
        ji.wait_time_long waitMinute,
        -- 用车城市
        cc.SHORT_NAME useCarCity,
        -- 用车场景
        si.`name` userCarScene,
        -- 用车制度
        ri.`name` userCarRegime,
        round((UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(oi.create_time))/60)   waitingTime,
        -- 服务类型
        ji.charter_car_type serverType,
        -- 状态
        case
        when right (oi.state,3)='100' then '待派车'
        when right (oi.state,3)>='299' and right (oi.state,3)!='900' then '已处理'
        when right (oi.state,3)='900' then '已过期'
        ELSE '' END state,
        -- 操作时间
        case
        when right (oi.state,3)='100' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S100'  limit 1)
        when right (oi.state,3)='299' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S299' limit 1)
        when right (oi.state,3)= '900' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S921' limit 1)
        ELSE now() END opDate,
        -- 1内部 2 外部
        case when cgi.it_is_inner='C000' then 1
        when cgi.it_is_inner='C111'	then 2
        else 1 end inOrOut,
        -- if(ISNULL(od.next_car_group_id),1,2) inOrOut,
        -- 车队类型 C000   内部车队  C111   外部车队
        -- cgi.it_is_inner carGroupType,
        -- 包车的总天数
        ji.use_time  charterCarDaysCount,
        -- 车型id
        ai.car_type_id carTypeId,
        -- 车型名字
        ecti.name carTypeName,
        -- 用车备注
        ai.notes,
        od.car_group_user_mode carGroupUserMode,
        od.it_is_self_driver selfDriver,
        oai.city_postal_code useCarCityCode,
        od.it_is_use_inner_car_group useCarGroupType,
        ai.reason reason
        FROM
        order_info oi
        LEFT JOIN ecmp_user eu ON oi.user_id = eu.user_id
        LEFT JOIN ecmp_org eo ON eu.dept_id = eo.dept_id
        LEFT JOIN ecmp_org eor ON eo.company_id= eor.dept_id
        LEFT JOIN journey_info ji ON ji.journey_id = oi.journey_id
        LEFT JOIN journey_passenger_info jpi ON jpi.journey_id = oi.journey_id
        LEFT JOIN regime_info ri ON ri.regimen_id = ji.regimen_id
        LEFT JOIN scene_regime_relation srr ON srr.regimen_id = ri.regimen_id
        LEFT JOIN scene_info si ON srr.scene_id = si.scene_id
        LEFT JOIN order_address_info oai ON (oai.order_id = oi.order_id and oai.type='A000')
        LEFT JOIN order_address_info oaitwo ON (oaitwo.order_id = oi.order_id and oaitwo.type='A999')
        LEFT JOIN china_city cc ON cc.CITY_CODE = oai.city_postal_code
        LEFT JOIN order_dispatche_detail_info od ON od.order_id = oi.order_id
        LEFT JOIN car_group_info cgi on (cgi.car_group_id = od.car_cg_id or cgi.car_group_id=od.driver_cg_id or od.next_car_group_id = cgi.car_group_id)
        left join journey_user_car_power jucp on jucp.node_id=oi.node_id
        left join apply_info ai on ai.apply_id=jucp.apply_id
        left join enterprise_car_type_info ecti on ecti.car_type_id=ai.car_type_id
        WHERE 1 = 1
        <if test="isIndex == 1">
            --             and oi.order_id in (select distinct order_id from order_state_trace_info where order_id in
            --             (select distinct order_id from order_state_trace_info where state in ('S100'))
            --             and order_id not in (select distinct order_id from order_state_trace_info where state in ('S270', 'S279', 'S277'))  )
            and oi.order_id in (
            select a.orderId from (select order_id orderId,max(state) mstate from order_state_trace_info GROUP BY order_id ) a where a.mstate = 'S100'
            )
        </if>
        <if test="homePageWaitingCarState!=null and homePageWaitingCarState != ''">
            and  oi.state = #{homePageWaitingCarState}
        </if>
        <if test="homePageExpireCarState!=null and homePageExpireCarState != ''">
            and  oi.state = #{homePageExpireCarState}
        </if>
        <if test="homePageUsingCarState!=null and homePageUsingCarState != ''">
            and  oi.state >= 'S299' and  oi.state != 'S900'
        </if>
        <if test="homeDynamicBeginTime!=null and '' != homeDynamicBeginTime">
            and  oi.create_time &gt;= #{homeDynamicBeginTime}
        </if>
        <if test="homeDynamicEndTime!=null and '' != homeDynamicEndTime">
            and  oi.create_time &lt;= #{homeDynamicEndTime}
        </if>
        <if test="isIndex == 2">
            and oi.order_id in (select distinct order_id from order_state_trace_info where order_id in
            (select distinct order_id from order_state_trace_info where state in ('S299', 'S921', 'S100','S930'))
            and order_id not in (select distinct order_id from order_state_trace_info where state in ('S270', 'S279', 'S277'))  )
        </if>

        <if test="companyId!=null and companyId!=''">
            and  oi.company_id=#{companyId}
        </if>
        <if test="applyName!=null and applyName!=''">
            and  eu.nick_name=#{applyName}
        </if>
        <if test="applyMobile!=null and applyMobile!=''">
            and  eu.phonenumber=#{applyMobile}
        </if>
        <if test="cityCode!=null and cityCode!=''">
            and  cc.SHORT_NAME=#{cityCode}
        </if>
        <if test="useCarMode!=null and useCarMode!=''">
            and  oi.use_car_mode=#{useCarMode}
        </if>
        <if test="dispatchStatus!=null and dispatchStatus!=''">
            and  oi.state=#{dispatchStatus}
        </if>
        <if test="optStartDate!=null  and  optStartDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{optStartDate},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="optEndDate!=null  and  optEndDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{optEndDate},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="orderId!=null and orderId != ''">
            and oi.order_id=#{orderId}
        </if>
        and  oi.it_is_supplement='N000'
        and ((oi.user_id in (select distinct user_id from ecmp_user where dept_id in
        (select dept_id from car_group_serve_org_relation where car_group_id in
        (select car_group_id from car_group_dispatcher_info where user_id=#{userId})))
        and cgi.car_group_id in(
        SELECT car_group_id FROM car_group_dispatcher_info WHERE user_id =#{userId}
        )) or (
        oi.user_id IN (
        SELECT DISTINCT
        user_id
        FROM
        ecmp_user
        WHERE
        dept_id IN ( SELECT dept_id FROM car_group_serve_org_relation WHERE car_group_id IN ( SELECT car_group_id FROM car_group_dispatcher_info WHERE user_id =#{userId})
        and car_group_id in (
        select i.car_group_id from car_group_info i where i.it_is_inner='C000')))))
        ORDER BY
        oi.state,oai.action_time ASC
    </select>

    <select id="queryHomePageDispatchListCharterCar" parameterType="com.hq.ecmp.mscore.domain.ApplyDispatchQuery" resultType="com.hq.ecmp.mscore.vo.DispatchVo">

        SELECT DISTINCT
        -- 订单id
        oi.order_id orderId,
        -- 部门名称
        eo.dept_name AS deptName,
        -- 公司名称
        eor.dept_name AS companyName,
        -- 操作权限  0：有权限  1:没有权限
        '0'  operationPermission,
        -- 申请人姓名
        eu.nick_name  applyUserName,
        -- 申请人手机号
        eu.phonenumber applyUserTel,
        -- 乘车人
        jpi.name  useCarUserName,
        -- 乘车人电话
        jpi.mobile userCarUserMobile,
        -- 同行人数量
        jpi.peer_number travelPartnerCount,
        -- 开始时间
        oai.action_time useCarDate,
        -- 预计结束时间
        oaitwo.action_time endDate,
        -- 上车地址
        oai.address startSite,
        -- 下车地址
        oaitwo.address endSite,
        -- 是否往返
        ji.it_is_return itIsReturn,
        -- 预计等待时长
        ji.wait_time_long waitMinute,
        -- 用车城市
        cc.SHORT_NAME useCarCity,
        -- 用车场景
        si.`name` userCarScene,
        -- 用车制度
        ri.`name` userCarRegime,
        round((UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(oi.create_time))/60)   waitingTime,
        -- 服务类型
        ji.charter_car_type serverType,
        -- 状态
        case
        when right (oi.state,3)='100' then '待派车'
        when right (oi.state,3)>='299' and right (oi.state,3)!='900' then '已处理'
        when right (oi.state,3)='900' then '已过期'
        ELSE '' END state,
        -- 操作时间
        case
        when right (oi.state,3)='100' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S100'  limit 1)
        when right (oi.state,3)='299' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S299' limit 1)
        when right (oi.state,3)= '900' then (select create_time from order_state_trace_info sti where sti.order_id=oi.order_id and sti.state='S921' limit 1)
        ELSE now() END opDate,
        -- 1内部 2 外部
        case when cgi.it_is_inner='C000' then 1
        when cgi.it_is_inner='C111'	then 2
        else 1 end inOrOut,
        -- if(ISNULL(od.next_car_group_id),1,2) inOrOut,
        -- 车队类型 C000   内部车队  C111   外部车队
        -- cgi.it_is_inner carGroupType,
        -- 包车的总天数
        ji.use_time  charterCarDaysCount,
        -- 车型id
        ai.car_type_id carTypeId,
        -- 车型名字
        ecti.name carTypeName,
        -- 用车备注
        ai.notes,
        od.car_group_user_mode carGroupUserMode,
        od.it_is_self_driver selfDriver,
        oai.city_postal_code useCarCityCode,
        od.it_is_use_inner_car_group useCarGroupType,
        ai.reason reason
        FROM
        order_info oi
        LEFT JOIN ecmp_user eu ON oi.user_id = eu.user_id
        LEFT JOIN ecmp_org eo ON eu.dept_id = eo.dept_id
        LEFT JOIN ecmp_org eor ON eo.company_id= eor.dept_id
        LEFT JOIN journey_info ji ON ji.journey_id = oi.journey_id
        LEFT JOIN journey_passenger_info jpi ON jpi.journey_id = oi.journey_id
        LEFT JOIN regime_info ri ON ri.regimen_id = ji.regimen_id
        LEFT JOIN scene_regime_relation srr ON srr.regimen_id = ri.regimen_id
        LEFT JOIN scene_info si ON srr.scene_id = si.scene_id
        LEFT JOIN order_address_info oai ON (oai.order_id = oi.order_id and oai.type='A000')
        LEFT JOIN order_address_info oaitwo ON (oaitwo.order_id = oi.order_id and oaitwo.type='A999')
        LEFT JOIN china_city cc ON cc.CITY_CODE = oai.city_postal_code
        LEFT JOIN order_dispatche_detail_info od ON od.order_id = oi.order_id
--         LEFT JOIN car_group_info cgi on (cgi.car_group_id = od.car_cg_id or cgi.car_group_id=od.driver_cg_id)
        LEFT JOIN car_group_info cgi on (cgi.car_group_id = od.car_cg_id or cgi.car_group_id=od.driver_cg_id or od.next_car_group_id = cgi.car_group_id)
        left join journey_user_car_power jucp on jucp.node_id=oi.node_id
        left join apply_info ai on ai.apply_id=jucp.apply_id
        left join enterprise_car_type_info ecti on ecti.car_type_id=ai.car_type_id
        WHERE 1 = 1
        <if test="isIndex == 1">
            --             and oi.order_id in (select distinct order_id from order_state_trace_info where order_id in
            --             (select distinct order_id from order_state_trace_info where state in ('S100'))
            --             and order_id not in (select distinct order_id from order_state_trace_info where state in ('S270', 'S279', 'S277'))  )
            and oi.order_id in (
            select a.orderId from (select order_id orderId,max(state) mstate from order_state_trace_info GROUP BY order_id ) a where a.mstate = 'S100'
            )
        </if>
        <if test="homePageWaitingCarState!=null and homePageWaitingCarState != ''">
            and  oi.state = #{homePageWaitingCarState}
        </if>
        <if test="homePageExpireCarState!=null and homePageExpireCarState != ''">
            and  oi.state = #{homePageExpireCarState}
        </if>
        <if test="homePageUsingCarState!=null and homePageUsingCarState != ''">
            and  oi.state >= 'S299' and  oi.state != 'S900'
        </if>
        <if test="homeDynamicBeginTime!=null and '' != homeDynamicBeginTime">
            and  oi.create_time &gt;= #{homeDynamicBeginTime}
        </if>
        <if test="homeDynamicEndTime!=null and '' != homeDynamicEndTime">
            and  oi.create_time &lt;= #{homeDynamicEndTime}
        </if>
        <if test="isIndex == 2">
            and oi.order_id in (select distinct order_id from order_state_trace_info where order_id in
            (select distinct order_id from order_state_trace_info where state in ('S299', 'S921', 'S100','S930'))
            and order_id not in (select distinct order_id from order_state_trace_info where state in ('S270', 'S279', 'S277'))  )
        </if>

        <if test="companyId!=null and companyId!=''">
            and  oi.company_id=#{companyId}
        </if>
        <if test="applyName!=null and applyName!=''">
            and  eu.nick_name=#{applyName}
        </if>
        <if test="applyMobile!=null and applyMobile!=''">
            and  eu.phonenumber=#{applyMobile}
        </if>
        <if test="cityCode!=null and cityCode!=''">
            and  cc.SHORT_NAME=#{cityCode}
        </if>
        <if test="useCarMode!=null and useCarMode!=''">
            and  oi.use_car_mode=#{useCarMode}
        </if>
        <if test="dispatchStatus!=null and dispatchStatus!=''">
            and  oi.state=#{dispatchStatus}
        </if>
        <if test="optStartDate!=null  and  optStartDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{optStartDate},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="optEndDate!=null  and  optEndDate!='' ">
            and DATE_FORMAT(opDate,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{optEndDate},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="orderId!=null and orderId != ''">
            and oi.order_id=#{orderId}
        </if>
        and  oi.it_is_supplement='N000'
        and ((oi.user_id in (select distinct user_id from ecmp_user where dept_id in
        (select dept_id from car_group_serve_org_relation where car_group_id in
        (select car_group_id from car_group_dispatcher_info where user_id=#{userId})))
        and cgi.car_group_id in(
        SELECT car_group_id FROM car_group_dispatcher_info WHERE user_id =#{userId}
        )) or (
        oi.user_id IN (
        SELECT DISTINCT
        user_id
        FROM
        ecmp_user
        WHERE
        dept_id IN ( SELECT dept_id FROM car_group_serve_org_relation WHERE car_group_id IN ( SELECT car_group_id FROM car_group_dispatcher_info WHERE user_id =#{userId})
        and car_group_id in (
        select i.car_group_id from car_group_info i where i.it_is_inner='C000')))))
        ORDER BY
        oi.state,oai.action_time ASC
    </select>

    <select id="getUseApplySearchList" parameterType="com.hq.ecmp.mscore.vo.UserApplySingleVo" resultType="com.hq.ecmp.mscore.vo.UserApplySingleVo">

        SELECT DISTINCT
        -- 申请id
        ai.apply_id applyId,
        -- 申请人姓名
        eu.nick_name applyName,
        -- 申请人手机号
        eu.phonenumber applyPhoneNumber,
        -- 用车人姓名
        jpi.name			  vehicleUserName,
        -- 用车人手机号
        jpi.mobile	vehicleUserPhoneNumber,
        -- 同行人数
        jpi.peer_number  peerNumber,
        -- 用车单位
        eo.dept_name vehicleUserCompany,
        -- 服务类型
        case
        when right (ji.charter_car_type,3)='001' then '半日租(4小时)'
        when right (ji.charter_car_type,3)='002' then '整日租(8小时)'
        when right (ji.charter_car_type,3)='009' then  CONCAT('多日租','(',ji.use_time,'日',')')
        ELSE '' END charterCarType,
        -- 服务车型
        ecty.name carLevel,
        -- 车辆类型
        ci.car_type carType,
        -- 车辆车牌号
        ci.car_license carLicense,
        -- 车辆颜色
        ci.car_color  carColor,
        -- 用车时间
        ji.use_time useTime,
        -- 用车开始时间
        ji.start_date beginTime,
        -- 用车结束时间
        ji.end_date endTime,
        -- 申请事由
        ai.reason vehicleUseReason,
        -- 用车备注
        ai.notes vehicleRemarks,
        -- 车辆归属
        cgi.car_group_name carCompany,
        -- 驾驶员姓名
        di.driver_name driverName,
        -- 等待时长
        round((UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(oi.create_time))/60)   waitingTime,
        -- 驾驶员手机号
        di.mobile driverPhone,
        -- 驾驶员归属
        cgiTwo.car_group_name driverCompany,
        -- 状态
        oai1.address beginAddress,
        -- 出发地址
        oai2.address endAddress,
        -- 到达地址
        oi.order_number order_number,
        -- 订单编号
        oi.use_car_mode useCarMode,
        -- 用车方式
        oscdrio.amount amount,
        oi.order_id orderId,
        -- 费用合计
        case
        when right (z.state,3)='100' then '待派车'
        when right (z.state,3)<![CDATA[ >= ]]>'299' and right (z.state,3)<![CDATA[ <= ]]>'900'   then '已派车'
        when right (ai.state,3)='004' OR right (z.state,3)='911' then '已撤销'
        when right (ai.state,3)='005' OR right (z.state,3)='921' then '已过期'
        when right (z.state,3)='930' then '已驳回'
        ELSE '' END orderState
        FROM
        apply_info ai  LEFT JOIN  journey_info ji ON ai.journey_id = ji.journey_id
        LEFT JOIN  ecmp_user eu    ON eu.user_id = ji.user_id
        LEFT JOIN  journey_passenger_info jpi ON jpi.journey_id = ji.journey_id and jpi.it_is_peer = '00'
        LEFT JOIN  ecmp_org eo     ON eo.dept_id  = eu.dept_id
        LEFT JOIN  order_info  oi  ON oi.journey_id = ji.journey_id
        LEFT JOIN  car_info    ci  ON ci.car_id = oi.car_id
        LEFT JOIN  enterprise_car_type_info  ecty ON ecty.car_type_id = ai.car_type_id
        LEFT JOIN  car_group_info cgi ON cgi.car_group_id = ci.car_group_id
        LEFT JOIN  driver_info di  ON di.driver_id = oi.driver_id
        LEFT JOIN  car_group_driver_relation cgdr ON cgdr.driver_id = di.driver_id
        LEFT JOIN  car_group_info cgiTwo ON cgiTwo.car_group_id = cgdr.car_group_id
        LEFT JOIN (select order_id,state from order_state_trace_info where trace_id in (select Max(trace_id) traceId from order_state_trace_info  group by order_id))  z on z.order_id=oi.order_id
        left join
        (select order_id,type,address,address_long from order_address_info where type = 'A000') oai1 on  oai1.order_id = oi.order_id
        left join
        (select order_id,type,address,address_long from order_address_info where type = 'A999') oai2 on  oai2.order_id = oi.order_id
        left join  order_settling_info osi on osi.order_id = oi.order_id
        left join
        (select sum(total_fee) amount,order_id orderId from order_service_cost_detail_record_info group by order_id) oscdrio on oscdrio.orderId = oi.order_id
        where  oi.service_type='5000'
        <if test="userId!=null and '' != userId">
            and  eu.user_id = #{userId}
        </if>
        <if test="companyId!=null">
            and  ai.company_id = #{companyId}
        </if>
        <if test="applyName!=null and '' != applyName">
            and  eu.nick_name like concat('%',#{applyName},'%')
        </if>
        <if test="applyPhoneNumber!=null and '' != applyPhoneNumber">
            and  eu.phonenumber like concat('%',#{applyPhoneNumber},'%')
        </if>
        <if test="vehicleUserName!=null and '' != vehicleUserName">
            and  jpi.name  like concat('%',#{vehicleUserName},'%')
        </if>
        <if test="vehicleUserPhoneNumber!=null and '' != vehicleUserPhoneNumber">
            and  jpi.mobile   like concat('%',#{vehicleUserPhoneNumber},'%')
        </if>
        <if test="vehicleUserCompany!=null and '' != vehicleUserCompany">
            and  eo.dept_name=#{vehicleUserCompany}
        </if>
        <if test="charterCarType!=null and '' != charterCarType">
            and  ji.charter_car_type=#{charterCarType}
        </if>
        <if test="peerNumber!=null and '' != peerNumber">
            and  jpi.peer_number=#{peerNumber}
        </if>
        <if test="carLevel!=null and ''!= carLevel">
            and  ecty.name=#{carLevel}
        </if>
        <if test="beginTime!=null  and  beginTime!='' ">
            and DATE_FORMAT(ji.start_date,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{beginTime},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="endTime!=null  and  endTime!='' ">
            and DATE_FORMAT(ji.end_date,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="homePageWaitingCarState!=null and homePageWaitingCarState != ''">
            and  oi.state = #{homePageWaitingCarState}
        </if>
        <if test="homePageUsingCarState!=null and homePageUsingCarState != ''">
            and  oi.state >= 'S299' and  oi.state != 'S900'
        </if>
        <if test="homePageExpireCarState!=null and homePageExpireCarState != ''">
            and  ai.state = #{homePageExpireCarState}
        </if>
        <if test="homePageRejectState!=null and homePageRejectState != ''">
            or ( eu.user_id = #{userId} and oi.service_type='5000' and ai.state = #{homePageRejectState} and DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= date(ai.create_time))
        </if>
        <if test="homePageToBeConfirmedState!=null and '' != homePageToBeConfirmedState">
            and  oi.state = #{homePageToBeConfirmedState}
        </if>
        <if test="homeDynamicBeginTime!=null and '' != homeDynamicBeginTime">
            and  ai.create_time &gt;= #{homeDynamicBeginTime}
        </if>
        <if test="homeDynamicEndTime!=null and '' != homeDynamicEndTime">
            and  ai.create_time &lt;= #{homeDynamicEndTime}
        </if>
        order by orderState desc
    </select>


    <select id="getUseApplyCounts" parameterType="com.hq.ecmp.mscore.vo.UserApplySingleVo" resultType="com.hq.ecmp.mscore.vo.UserApplySingleVo">

        SELECT DISTINCT
        -- 申请id
        ai.apply_id applyId,
        -- 申请人姓名
        eu.nick_name applyName,
        -- 申请人手机号
        eu.phonenumber applyPhoneNumber,
        -- 用车人姓名
        jpi.name			  vehicleUserName,
        -- 用车人手机号
        jpi.mobile	vehicleUserPhoneNumber,
        -- 同行人数
        jpi.peer_number  peerNumber,
        -- 用车单位
        eo.dept_name vehicleUserCompany,
        -- 服务类型
        case
        when right (ji.charter_car_type,3)='001' then '半日租(4小时)'
        when right (ji.charter_car_type,3)='002' then '整日租(8小时)'
        when right (ji.charter_car_type,3)='009' then  CONCAT('多日租','(',ji.use_time,')','日')
        ELSE '' END charterCarType,
        -- 服务车型
        ecty.name carLevel,
        -- 车辆类型
        ci.car_type carType,
        -- 车辆车牌号
        ci.car_license carLicense,
        -- 车辆颜色
        ci.car_color  carColor,
        -- 用车时间
        ji.use_time useTime,
        -- 用车开始时间
        ji.start_date beginTime,
        -- 用车结束时间
        ji.end_date endTime,
        -- 申请事由
        ai.reason vehicleUseReason,
        -- 用车备注
        ai.notes vehicleRemarks,
        -- 车辆归属
        cgi.car_group_name carCompany,
        -- 驾驶员姓名
        di.driver_name driverName,
        -- 驾驶员手机号
        di.mobile driverPhone,
        -- 驾驶员归属
        cgiTwo.car_group_name driverCompany,
        -- 状态
        oai1.address beginAddress,
        -- 出发地址
        oai2.address endAddress,
        -- 到达地址
        oi.order_number orderNumber,
        -- 订单号
        oi.use_car_mode useCarMode,
        -- 用车方式
        oscdrio.amount amount,
        -- 费用合计
        oi.order_id orderId,
        case
        when right (oi.state,3)='100' then '待派车'
        when right (oi.state,3)='699' then '待确认'
--        when right (oi.state,3)>='299' and right (oi.state,3)!='900' then '已派车'
        when right (ai.state,3)='004' then '已撤销'
        when right (ai.state,3)='005' then '已过期'
        ELSE '' END orderState
        FROM
        apply_info ai  LEFT JOIN  journey_info ji ON ai.journey_id = ji.journey_id
        LEFT JOIN  ecmp_user eu    ON eu.user_id = ji.user_id
        LEFT JOIN  journey_passenger_info jpi ON jpi.journey_id = ji.journey_id and jpi.it_is_peer = '00'
        LEFT JOIN  ecmp_org eo     ON eo.dept_id  = eu.dept_id
        LEFT JOIN  order_info  oi  ON oi.journey_id = ji.journey_id
        LEFT JOIN  car_info    ci  ON ci.car_id = oi.car_id
        LEFT JOIN  enterprise_car_type_info  ecty ON ecty.car_type_id = ci.car_type_id
        LEFT JOIN  car_group_info cgi ON cgi.car_group_id = ci.car_group_id
        LEFT JOIN  driver_info di  ON di.driver_id = oi.driver_id
        LEFT JOIN  car_group_driver_relation cgdr ON cgdr.driver_id = di.driver_id
        LEFT JOIN  car_group_info cgiTwo ON cgiTwo.car_group_id = cgdr.car_group_id
        left join
        (select order_id,type,address,address_long from order_address_info where type = 'A000') oai1 on  oai1.order_id = oi.order_id
        left join
        (select order_id,type,address,address_long from order_address_info where type = 'A999') oai2 on  oai2.order_id = oi.order_id
        left join  order_settling_info osi on osi.order_id = oi.order_id
        left join
        (select sum(total_fee) amount,order_id orderId from order_service_cost_detail_record_info group by order_id) oscdrio on oscdrio.orderId = oi.order_id
        where  oi.service_type='5000'
        <if test="userId!=null and '' != userId">
            and  eu.user_id = #{userId}
        </if>
        <if test="companyId!=null">
            and  ai.company_id = #{companyId}
        </if>
        <if test="applyName!=null and '' != applyName">
            and  eu.nick_name = #{applyName}
        </if>
        <if test="applyPhoneNumber!=null and '' != applyPhoneNumber">
            and  eu.phonenumber = #{applyPhoneNumber}
        </if>
        <if test="vehicleUserName!=null and '' != vehicleUserName">
            and  jpi.name=#{vehicleUserName}
        </if>
        <if test="vehicleUserPhoneNumber!=null and '' != vehicleUserPhoneNumber">
            and  jpi.mobile=#{vehicleUserPhoneNumber}
        </if>
        <if test="vehicleUserCompany!=null and '' != vehicleUserCompany">
            and  eo.dept_name=#{vehicleUserCompany}
        </if>
        <if test="charterCarType!=null and '' != charterCarType">
            and  ji.charter_car_type=#{charterCarType}
        </if>
        <if test="peerNumber!=null and '' != peerNumber">
            and  jpi.peer_number=#{peerNumber}
        </if>
        <if test="carLevel!=null and ''!= carLevel">
            and  ecty.name=#{carLevel}
        </if>
        <if test="beginTime!=null  and  beginTime!='' ">
            and DATE_FORMAT(ji.start_date,'%Y-%m-%d %H:%i:%S') &gt;= DATE_FORMAT(#{beginTime},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="endTime!=null  and  endTime!='' ">
            and DATE_FORMAT(ji.end_date,'%Y-%m-%d %H:%i:%S') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d %H:%i:%S')
        </if>
        <if test="homePageWaitingCarState!=null and homePageWaitingCarState != ''">
            and  oi.state = #{homePageWaitingCarState}
        </if>
        <if test="homePageUsingCarState!=null and homePageUsingCarState != ''">
            and  oi.state >= 'S299' and  oi.state &lt;= 'S900'
        </if>
        <if test="homePageExpireCarState!=null and homePageExpireCarState != ''">
            and  ai.state = #{homePageExpireCarState}
        </if>
        <if test="homePageRejectState!=null and homePageRejectState != ''">
            or  (ai.state = #{homePageRejectState} and DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= date(ai.create_time))
        </if>
        <if test="homePageToBeConfirmedState!=null and '' != homePageToBeConfirmedState">
            and  oi.state = #{homePageToBeConfirmedState}
        </if>
        <if test="homeDynamicBeginTime!=null and '' != homeDynamicBeginTime">
            and  ai.create_time &gt;= #{homeDynamicBeginTime}
        </if>
        <if test="homeDynamicEndTime!=null and '' != homeDynamicEndTime">
            and  ai.create_time &lt;= #{homeDynamicEndTime}
        </if>
        order by orderState desc
    </select>

    <update id="changeOrder" parameterType="com.hq.ecmp.mscore.domain.OrderInfo">
        update order_info set
             driver_id = null,
             car_id = null,
             use_car_mode = null,
             state ='S100',
             driver_name =null,
             driver_mobile =null,
             car_license =null,
             demand_car_level=null,
             update_by =#{updateBy},
             update_time = #{updateTime},
             car_model=null,
             car_color=null,
             driver_grade=null
       where order_id=#{orderId}
    </update>

    <select id="getOrderInfo" parameterType="java.lang.Long" resultType="java.util.Map">
        SELECT DISTINCT
            cost.start_time startDate,
            cost.end_time endDate,
            cost.total_fee totalFee,--行程单价
            oi.order_number orderNumber,
            ci.car_license carLicense,
            ci.car_type carType,
            di.driver_name driverName,
            di.mobile mobile,
            cgi.car_group_name carGroupName,
            cgi.telephone telephone,
            us.nick_name dispatcherNickName,
            us.phonenumber dispatcherPhoneNumber,
            jo.mobile riderMobile,
            eu.phonenumber applyMobile
            FROM
                order_info oi
                LEFT JOIN journey_info ji ON oi.journey_id = ji.journey_id
                LEFT JOIN ecmp_user eu ON eu.user_id = ji.user_id
                LEFT JOIN ecmp_org eo ON eo.dept_id = eu.dept_id
                LEFT JOIN car_info ci ON ci.car_id = oi.car_id
                LEFT JOIN car_group_info cgi ON cgi.car_group_id = ci.car_group_id
                LEFT JOIN driver_info di ON di.driver_id = oi.driver_id
                LEFT JOIN car_group_info cgiTwo ON cgiTwo.car_group_id = ci.car_group_id
                LEFT JOIN order_dispatche_detail_info det ON oi.order_id = det.order_id
                LEFT JOIN ecmp_user us ON det.inner_dispatcher = us.user_id
                LEFT JOIN journey_passenger_info jo on oi.journey_id = jo.journey_id
				left join (
				    SELECT * FROM
				    order_service_cost_detail_record_info
				    WHERE order_id = #{orderId} ORDER BY create_time DESC LIMIT 1
				    ) cost on oi.order_id = cost.order_id
				WHERE oi.order_id =  #{orderId}
    </select>
</mapper>
